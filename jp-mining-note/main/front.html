<!--
WARNING: This template is auto-generated.
Any changes to this template WILL BE LOST if you decide to update the card.
See https://aquafina-water-bottle.github.io/jp-mining-note/modding/
if you want to modify the card templates and css without losing your changes
upon updates.

JPMN-COMPILE-TIME-OPTIONS-JSON:
{
  "compile-options": {
    "allow-user-defined-modules": false,
    "always-filled-fields": [],
    "css-folders": [
      "base",
      "dictionaries"
    ],
    "enabled-modules": [
      "sent-utils",
      "kanji-hover",
      "auto-pitch-accent",
      "img-utils",
      "customize-open-fields"
    ],
    "hardcoded-runtime-options": false,
    "keybinds-enabled": true,
    "never-filled-fields": []
  }
}

-->


<script>


/* quick fix for legacy anki versions (replaces ?? operator) */
function nullish(a, b) {
  if ((typeof a === "undefined") || (a === null)) {
    return b;
  }
  return a;
}


/// 
function getSetting(keys, defaultVal) {
  if (typeof JPMNOpts === "undefined") {
    return defaultVal;
  }

  let keyList = ["settings"].concat(keys);

  let obj = JPMNOpts;
  for (let key of keyList) {
    if (!(key in obj)) {

      // checks if we need to warn, manual search
      if ("settings" in JPMNOpts && "debug" in JPMNOpts["settings"] && JPMNOpts["settings"]["debug"]) {
        LOGGER.warn("Option " + keys.join(".") + " is not defined in the options file.");
      }
      return defaultVal;
    }
    obj = obj[key];
  }
  return obj;
};
///  


var JPMNLogger = (() => {
  class JPMNLogger {
    constructor(name=null) {
      this._name = name;
      this._uniqueKeys = new Set();
    }


    error(message) {
      let groupEle = document.getElementById("info_circle_text_error");
      this._appendMsg(message, groupEle);
      let infoCirc = document.getElementById("info_circle");
      if (!infoCirc.classList.contains("info-circle-error")) {
        infoCirc.classList.add("info-circle-error")
      }
    }

    errorStack(stack) {
      try {
        let ignoredErrors = getSetting(['ignored-errors',],['ReferenceError: EFDRC is not defined.']);
        for (let substr of ignoredErrors) {
          if (stack.includes(substr)) {
            // ignores
            return;
          }
        }

        let stackList = stack.split(" at ");
        for (let i = 1; i < stackList.length; i++) {
          stackList[i] = ">>> " + stackList[i];
        }
        this.error(stackList);
      } catch (e) {
        // in case the above fails for some reason
        // better to throw an error that is not as prettily formatted
        // than to essentially have it go missing
        this.error(stack);
      }

    }


    assert(condition, message) {
      if (!condition) {
        this.error("(assert) " + message);
      }
    }

    removeWarn(key) {
      // assumes that this is a unique warn message

      if (!this._uniqueKeys.has(key)) {
        return;
      }

      let groupEle = document.getElementById("info_circle_text_warning");
      for (let e of groupEle.children) {
        if (e.getAttribute("data-key") === key) {
          groupEle.removeChild(e);
        }
      }

      let infoCirc = document.getElementById("info_circle");
      if (groupEle.children.length === 0 && infoCirc.classList.contains("info-circle-warning")) {
        infoCirc.classList.remove("info-circle-warning")
      }

      this._uniqueKeys.delete(key);
    }

    // key defaults to the message if unique is true and key is null
    // key is ignored if unique == false
    warn(message, unique=true, key=null) {

      // skips any non-unique warns as defined by the key
      if (unique) {
        if (key === null) {
          key = message;
        }

        if (this._uniqueKeys.has(key)) {
          return;
        }
      }

      let groupEle = document.getElementById("info_circle_text_warning");
      this._appendMsg(message, groupEle, key);
      let infoCirc = document.getElementById("info_circle");
      if (!infoCirc.classList.contains("info-circle-warning")) {
        infoCirc.classList.add("info-circle-warning");
      }

      if (key !== null) {
        this._uniqueKeys.add(key);
      }

    }

    info(message) {
      let groupEle = document.getElementById("info_circle_text_info");
      this._appendMsg(message, groupEle);
    }

    debug(message) {
      if (getSetting(['debug',],false)) {
        this.info(message);
      }
    }

    leech() {
      let groupEle = document.getElementById("info_circle_text_leech");
      this._appendMsg("", groupEle);
      let infoCirc = document.getElementById("info_circle");
      if (!infoCirc.classList.contains("info-circle-leech")) {
        infoCirc.classList.add("info-circle-leech");
      }
    }

    _appendMsg(message, groupEle, key=null) {
      // I think this stops an infinite loop somewhere if you log a null for some reason...
      if (message === null) {
        message = "null";
      }

      if (this._name !== null) {
        message = `(${this._name}) ${message}`;
      }

      let msgEle = document.createElement('div');
      msgEle.classList.add("info-circle__message")
      if (key !== null) {
        msgEle.setAttribute("data-key", key);
      }

      if (Array.isArray(message)) {
        if (message.length > 0) {
          msgEle.textContent = message[0];

          for (let line of message.slice(1)) {
            let lineEle = document.createElement('div');
            lineEle.textContent = line;
            msgEle.appendChild(lineEle);
          }
        }

      } else {
        msgEle.textContent = message;
      }
      groupEle.appendChild(msgEle);
    }

  }

  return JPMNLogger;
})();


/* global logger object for any javascript outside of modules that needs logging */
var LOGGER = new JPMNLogger();


// on any javascript error: log it
window.onerror = function(msg, url, lineNo, columnNo, error) {
  LOGGER.errorStack(error.stack);
}

// https://stackoverflow.com/a/55178672
window.onunhandledrejection = function(errorEvent) {
  LOGGER.error("Javascript handler error: `" + errorEvent.reason + "`");
}


function optionsNotFound() {
  LOGGER.warn("Options file not found. Did you place the options file in the media directory?");
}



</script>


<script onerror="optionsNotFound();" src="_jpmn-options.js"></script>
 


<div class="card-description">


    

    


  {{#IsHoverCard}}
    Hover ({{#IsSentenceCard}}Sentence{{/IsSentenceCard}}{{^IsSentenceCard}}Word{{/IsSentenceCard}})
  {{/IsHoverCard}}


  {{^IsHoverCard}}

    {{#IsClickCard}}
      Click ({{#IsSentenceCard}}Sentence{{/IsSentenceCard}}{{^IsSentenceCard}}Word{{/IsSentenceCard}})
    {{/IsClickCard}}

    {{^IsClickCard}}
      {{#IsTargetedSentenceCard}}
        TSC
      {{/IsTargetedSentenceCard}}
      {{^IsTargetedSentenceCard}}
        {{#IsSentenceCard}}
          Sentence
        {{/IsSentenceCard}}
        {{^IsSentenceCard}}
          Word
        {{/IsSentenceCard}}
      {{/IsTargetedSentenceCard}}  
    {{/IsClickCard}}  
  {{/IsHoverCard}} 

  {{#PAShowInfo}}

    /

    <!-- PADoNotTest or PASeparateWordCard == none -->
    {{#PADoNotTest}}{{^PASeparateWordCard}}
      None
    {{/PASeparateWordCard}}{{/PADoNotTest}}{{^PADoNotTest}}{{#PASeparateWordCard}}
      None
    {{/PASeparateWordCard}}{{/PADoNotTest}}{{#PADoNotTest}}{{#PASeparateWordCard}}
      None
    {{/PASeparateWordCard}}{{/PADoNotTest}}
    



    <!-- neither PADoNotTest, PASeparateWordCard are filled -->
    <!-- we then test the PA somewhere -->
    {{^PADoNotTest}}{{^PASeparateWordCard}}

      <!-- PASeparateSentenceCard or PATestOnlyWord == word -->
      {{#PASeparateSentenceCard}}{{^PATestOnlyWord}}
        Word
      {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}{{^PASeparateSentenceCard}}{{#PATestOnlyWord}}
        Word
      {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}{{#PASeparateSentenceCard}}{{#PATestOnlyWord}}
        Word
      {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}
    



      <!-- if none of the above, then we test the default value -->
      {{^PASeparateSentenceCard}}{{^PATestOnlyWord}}

        <!-- note: default for TSC is test word, may change in the future... -->
        {{#IsSentenceCard}}
          Sentence
        {{/IsSentenceCard}}
        {{^IsSentenceCard}}
          Word
        {{/IsSentenceCard}}

      {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}

    {{/PASeparateWordCard}}{{/PADoNotTest}}

  {{/PAShowInfo}} 



    
  <span class="info-circle" id="info_circle">
    <span class="info-circle-svg-wrapper">
      <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" class="bi bi-info-circle" viewBox="0 0 16 16">
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
      </svg>
    </span>

    <span class="info-circle-text-wrapper">
      <span class="info-circle-text" id="info_circle_text">
        <div class="info-circle-text-error" id="info_circle_text_error"></div>
        <div class="info-circle-text-warning" id="info_circle_text_warning"></div>
        <div class="info-circle-text-leech" id="info_circle_text_leech"></div>
        <div class="info-circle-text-info" id="info_circle_text_info">
          <div>
            Need help? View the
            <a href="https://aquafina-water-bottle.github.io/jp-mining-note/">documentation</a>.
          </div>
          <div>
            Have an issue?
            <a href="https://github.com/Aquafina-water-bottle/jp-mining-note/issues">Report it here</a>.
          </div>
          <div>
            View the
            <a href="https://github.com/Aquafina-water-bottle/jp-mining-note">source code</a>.
          </div>
        </div>
      </span>
    </span>
  </span>

    
  <!-- DO NOT CHANGE/REMOVE THIS: this is used to record the version when updating the note. -->
  <div class="card-description-ver">JP Mining Note: Version 0.10.2.1</div>


</div>







<div class="expression expression-box">
  {{#IsHoverCard}}
    
        
    <!-- fallback card card html
      in css: default hybrid css, but with hover instead of click -->
    <div class="expression__hybrid-wrapper">
      <div class="expression expression__hybrid expression__hybrid--hover" id="display">
        <span class="expression--sentence expression__hybrid-sentence
                     {{^IsSentenceCard}} highlight-bold {{/IsSentenceCard}}
                     {{#IsTargetedSentenceCard}} highlight-bold {{/IsTargetedSentenceCard}}
                     "
              id="hybrid-sentence">
          <span class="sentence-quote sentence-quote--open">「</span><span>{{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Sentence}}{{/AltDisplay}}</span><span class="sentence-quote sentence-quote--close">」</span>
        </span>
        <span class="expression--word expression__hybrid-word
            {{#IsTargetedSentenceCard}} expression__hybrid-word--sentence-indicator {{/IsTargetedSentenceCard}}
            {{^IsTargetedSentenceCard}}
              {{#IsSentenceCard}} expression__hybrid-word--sentence-indicator {{/IsSentenceCard}}
              {{^IsSentenceCard}} expression__hybrid-word--word-indicator {{/IsSentenceCard}}
            {{/IsTargetedSentenceCard}}
            expression__hybrid-word--hover-indicator"
            id="hybrid-word">
          {{Word}}
        </span>
      </div>

    </div>
        
  {{/IsHoverCard}} 

  {{^IsHoverCard}}
    {{#IsClickCard}}
      
            
      <!-- hybrid (sentence or word) card html
        in css: default hybrid css, with click -->
      <div class="expression__hybrid-wrapper">
        <div class="expression expression__hybrid expression__hybrid--click" id="display">
          <span class="expression--sentence expression__hybrid-sentence
                    {{^IsSentenceCard}} highlight-bold {{/IsSentenceCard}}
                    {{#IsTargetedSentenceCard}} highlight-bold {{/IsTargetedSentenceCard}}
                    "
                id="hybrid-sentence">
            <span class="sentence-quote sentence-quote--open">「</span><span>{{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Sentence}}{{/AltDisplay}}</span><span class="sentence-quote sentence-quote--close">」</span>
          </span>
          <span class="expression--word expression__hybrid-word
              {{#IsTargetedSentenceCard}} expression__hybrid-word--sentence-indicator {{/IsTargetedSentenceCard}}
              {{^IsTargetedSentenceCard}}
                {{#IsSentenceCard}} expression__hybrid-word--sentence-indicator {{/IsSentenceCard}}
                {{^IsSentenceCard}} expression__hybrid-word--word-indicator {{/IsSentenceCard}}
              {{/IsTargetedSentenceCard}}
              expression__hybrid-word--click-indicator"
              id="hybrid-word">
            {{Word}}
          </span>
        </div>
      </div>
            
    {{/IsClickCard}} 

    {{^IsClickCard}}

      {{#IsTargetedSentenceCard}}
        
                
        <div class="expression expression--sentence highlight-bold" id="display">
          <span class="sentence-quote sentence-quote--open">「</span><span>{{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Sentence}}{{/AltDisplay}}</span><span class="sentence-quote sentence-quote--close">」</span>
        </div>
                
      {{/IsTargetedSentenceCard}}

      {{^IsTargetedSentenceCard}}
        {{#IsSentenceCard}}
          
                    
          <div class="expression expression--sentence" id="display">
            <span class="sentence-quote sentence-quote--open">「</span><span>{{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Sentence}}{{/AltDisplay}}</span><span class="sentence-quote sentence-quote--close">」</span>
          </div>
                    
        {{/IsSentenceCard}}

        {{^IsSentenceCard}}
          
                    
          <div class="expression expression--word" id="display">
            {{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Word}}{{/AltDisplay}}
          </div>
                    
        {{/IsSentenceCard}}
      {{/IsTargetedSentenceCard}} 

    {{/IsClickCard}} 

  {{/IsHoverCard}} 

  
    
  <!-- appears to the left -->
  <div class="pa-indicator">
    {{#PAShowInfo}}
    <svg xmlns="http://www.w3.org/2000/svg" focusable="false" viewBox="0 0 50 50"
      class="pa-indicator__svg" id="flag_box_svg">
      <circle id="pa_indicator_circle" class="pa-indicator__circle" cx="25" cy="15" r="7">
        <title id=svg_title></title>
      </circle>
    </svg>
    {{/PAShowInfo}} 
  </div>
    

</div> <!-- expression box -->


{{#HintNotHidden}}
  <div class="center-box-1 hint">
    <div class="center-box-2">
      <div class="highlight-bold">{{HintNotHidden}}</div>
    </div>
  </div>
{{/HintNotHidden}}

<!-- https://stackoverflow.com/questions/1269589/css-center-block-but-align-contents-to-the-left -->
<!-- tl;dr wrap anything you want centered + left justified with center-box-1 and center-box-2 -->
{{#Hint}}
  <details class="hint" id="hint_details">
    <summary>Hint</summary>
    <div class="center-box-1">
      <div class="center-box-2">
        <div class="highlight-bold">{{Hint}}</div>
      </div>
    </div>
  </details>
{{/Hint}}


<!-- regular display -->
<!-- displays the audio and show/hide button, used only when testing pitch accent -->
{{#PAShowInfo}}

  <!-- only shown if:
    - word PA should be tested
    - sentence card
      - TSC and hybrid cards already shows the word
  -->
  {{#IsSentenceCard}}
  {{^PADoNotTest}}{{^PASeparateWordCard}}{{^IsTargetedSentenceCard}}{{^IsClickCard}}{{^IsHoverCard}}
  {{#PASeparateSentenceCard}}{{^PATestOnlyWord}}

    <button id="pa-button">Show</button>

  {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}{{^PASeparateSentenceCard}}{{#PATestOnlyWord}}

    <button id="pa-button">Show</button>

  {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}{{#PASeparateSentenceCard}}{{#PATestOnlyWord}}

    <button id="pa-button">Show</button>

  {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}
  


  {{/IsHoverCard}}{{/IsClickCard}}{{/IsTargetedSentenceCard}}{{/PASeparateWordCard}}{{/PADoNotTest}}
  {{/IsSentenceCard}}

  <!--
    if the display is a word: show sentence preview (spoilered)
  -->
  {{^IsSentenceCard}}{{^IsHoverCard}}{{^IsClickCard}}{{^IsTargetedSentenceCard}}
    
        
    <details class="glossary-details" id="full_sentence_front_details">
      <summary>Full Sentence</summary>
      <div class="center-box-1">
        <div class="center-box-2">
          <div class="full-sentence highlight-bold" id="full_sentence_front">
            {{furigana:SentenceReading}}
          </div>
        </div>
      </div>
    </details>
        
  {{/IsTargetedSentenceCard}}{{/IsClickCard}}{{/IsHoverCard}}{{/IsSentenceCard}}

  
    
  <span id="pa-silence-audio" style="display:none">{{PASilence}}</span>

  {{#SentenceAudio}}
    <span id="sentence-audio"> {{SentenceAudio}} </span>
  {{/SentenceAudio}}


  <script>
    // THIS IS A HACK: this hack is to not auto-play the audio at the front of the card
    // https://forums.ankiweb.net/t/disabling-audio-autoplay-for-certain-fields/6318/3
    // https://forums.ankiweb.net/t/controlling-display-and-function-of-audio-buttons/10234
    var elem = document.querySelector("#pa-silence-audio .soundLink, #pa-silence-audio .replaybutton");
    if (elem) {
      elem.click();
    }
  </script>
    

{{/PAShowInfo}} 





<script>



/// 





// GLOBALS: kanji-hover


// global cache for an entire card's kanji hover html
// maps key.word_reading -> html string
//var kanjiHoverCardCache = kanjiHoverCardCache ?? {};
var kanjiHoverCardCache = nullish(kanjiHoverCardCache, {});

// maps kanji -> [{set of used words}, html string]
//var kanjiHoverCache = kanjiHoverCache ?? {};
var kanjiHoverCache = nullish(kanjiHoverCache, {});


/// 







// GLOBALS: customize-open-fields


// note that this cache will NOT respect card review undos,
// but that should be a niche enough case to not warrent caching.
// maps key -> bool
var isNewCardCache = nullish(isNewCardCache, {});

/// 





(function () { // restricts ALL javascript to hidden scope

// "global" variables within the hidden scope
let note = (function () {
  let my = {};
  return my;
}());



/*
 * Toggles the display of any given details tag
 */
function toggleDetailsTag(ele) {
  if (ele.hasAttribute('open')) {
    ele.removeAttribute('open');
  } else {
    ele.setAttribute("open", "true");
  }
}


// START_BLOCK: js_functions





function hybridClick() {
  const hSent = document.getElementById("hybrid-sentence");
  const hWord = document.getElementById("hybrid-word");
  const svgEle = document.getElementById("flag_box_svg");
  const circ = document.getElementById("pa_indicator_circle");

  if (hSent.classList.contains("override-display-inline-block")) {
    // currently showing sentence, change to word
    hWord.classList.remove("override-display-none");
    hSent.classList.remove("override-display-inline-block");
    if (circ !== null) {
      circ.setAttributeNS(null, "cx", "25");
      circ.setAttributeNS(null, "cy", "15");
    }

    // re-adds if colored quotes exist
    if (svgEle !== null && hSent.hasAttribute("data-color-quotes")) {
      svgEle.style.display = "initial";
    }

  } else {
    // currently showing word, change to sentence
    hWord.classList.add("override-display-none");
    hSent.classList.add("override-display-inline-block");
    if (circ !== null) { // sentence
      if (hSent.innerText.length > 0 && hSent.innerText[0] === "「") {
        circ.setAttributeNS(null, "cx", "35");
        circ.setAttributeNS(null, "cy", "11");
      }
    }

    // removes if colored quotes exist
    if (svgEle !== null && hSent.hasAttribute("data-color-quotes")) {
      svgEle.style.display = "none";
    }
  }
}

/// 

function toggleHighlightWord() {
  let paButton = document.getElementById("pa-button");
  let d = document.getElementById("display");

  if (paButton.innerText == "Show") {
    paButton.innerText = "Hide";
    d.classList.add("highlight-bold");
  } else {
    paButton.innerText = "Show";
    if (d.classList.contains("highlight-bold")) {
      d.classList.remove("highlight-bold");
    }
  }
}

/// 
// END_BLOCK: js_functions








// ================
//  Sentence Utils
// ================
//
// processes the sentence
// - removes newlines
// - replaces bold with [...] if cloze deletion
// - handles adding or replacing quotes if specified

const JPMNSentUtils = (() => {
  const logger = new JPMNLogger("sent-utils");

  function processSentence(sentEle, isAltDisplay, isClozeDeletion, paIndicator) {
    if (typeof isAltDisplay === 'undefined') {
      LOGGER.warn("isAltDisplay is undefined");
      isAltDisplay = false;
    }

    // ASSUMPTION: all sentence elements are formatted as [quote, sentence, quote]
    let result = sentEle.children[1].innerHTML;

    // removes leading and trailing white space (equiv. of strip() in python)
    result = result.trim();

    // cloze deletion replacing bold with [...]
    if (typeof isClozeDeletion !== "undefined" && isClozeDeletion) {
      result = result.replace(/<b>.*?<\/b>/g, "<b>[...]</b>");
    }

    // removes newlines
    if ((!isAltDisplay && getSetting(['modules','sent-utils','remove-line-breaks',],false))
        || isAltDisplay && getSetting(['modules','sent-utils','remove-line-breaks-on-altdisplay',],false)) {
      let noNewlines = result.replace(/<br>/g, "");

      result = noNewlines;
    }

    let validQuotes = getSetting(['modules','sent-utils','quote-match-strings',],[['「', '」'], ['『', '』']]);
    let existingQuote = false;

    let openQuoteEle = sentEle.children[0];
    let closeQuoteEle = sentEle.children[2];

    for (let quotePair of validQuotes) {
      if ((result[0] === quotePair[0]) && (result[result.length-1] === quotePair[1])) {

        // adds quote to surrounding divs
        let openQuote = null;
        let closeQuote = null;
        [openQuote, closeQuote] = quotePair;
        openQuoteEle.innerText = openQuote;
        closeQuoteEle.innerText = closeQuote;

        result = result.slice(1, -1);
        existingQuote = true;
        break;
      }
    }

    let autoQuote = (
      (!isAltDisplay && getSetting(['modules','sent-utils','auto-quote-sentence',],true))
      || (isAltDisplay && getSetting(['modules','sent-utils','auto-quote-alt-display-sentence',],true))
    );
    if (!existingQuote && autoQuote) {
      /// 
      openQuoteEle.innerText = getSetting(['modules','sent-utils','auto-quote-open',],'「');
      closeQuoteEle.innerText = getSetting(['modules','sent-utils','auto-quote-close',],'」');
      /// 
    }

    // no quotes are added
    if (!existingQuote && !autoQuote) {
      // note that it defaults to having quotes + auto align without this module being ran
      // hence why all these steps have to be done
      openQuoteEle.innerText = "";
      closeQuoteEle.innerText = "";

      sentEle.style["text-indent"] = "0em";
      sentEle.style["padding-left"] = "0em";
    }


    // data-color-quotes: INDICATOR if the sentence quotes are colored or not
    // - attribute doesn't exist by default
    // - if exists, then the quotes are colored
    // - added in the sections below:

    /// 

    /// 
    /// {{#PAShowInfo}}

    // moves pa-indicator position
    if (!existingQuote && !autoQuote) {
      const circ = document.getElementById("pa_indicator_circle");
      if (circ !== null) {
        circ.setAttributeNS(null, "cx", "35");
        circ.setAttributeNS(null, "cy", "11");
      }
    }

    if ((existingQuote || autoQuote) && getSetting(['modules','sent-utils','pa-indicator-color-quotes',],false)) {
      // data-color-quotes tag within html is sentence-div dependent (preferable over a global state)
      sentEle.setAttribute("data-color-quotes", "true");

      if (paIndicator !== null) {
        openQuoteEle.classList.add(paIndicator.className);
        closeQuoteEle.classList.add(paIndicator.className);
      }

      /// {{#IsHoverCard}}
      let elems = document.getElementsByClassName("expression__hybrid-wrapper");
      if (elems.length > 0) {
        elems[0].classList.add("expression__hybrid-wrapper--hover-remove-flag");
      }
      /// {{/IsHoverCard}}

      // neither hover & click and is either one of TSC / sentence -> removes flag
      let svgEle = document.getElementById("flag_box_svg");

      /// ///{{^IsHoverCard}}///{{^IsClickCard}}
      /// ///{{#IsTargetedSentenceCard}}///{{^IsSentenceCard}}
      svgEle.style.display = "none";
      /// ///{{/IsSentenceCard}}///{{/IsTargetedSentenceCard}}///{{^IsTargetedSentenceCard}}///{{#IsSentenceCard}}
      svgEle.style.display = "none";
      /// ///{{/IsSentenceCard}}///{{/IsTargetedSentenceCard}}///{{#IsTargetedSentenceCard}}///{{#IsSentenceCard}}
      svgEle.style.display = "none";
      /// ///{{/IsSentenceCard}}///{{/IsTargetedSentenceCard}}
  


      /// ///{{/IsClickCard}}///{{/IsHoverCard}}

      // ASSUMPTION: IsClickCard + back side of the main card -> reveals sentence
      // i.e. hybridClick() is automatically called
      // ASSUMPTION: hybridClick() is called BEFORE this section
      /// 
    }
    /// {{/PAShowInfo}}
    /// 

    sentEle.children[1].innerHTML = result;

  }


  class JPMNSentUtils {
    constructor(isAltDisplay, isClozeDeletion, paIndicator) {
      this.isAltDisplay = isAltDisplay;
      this.isClozeDeletion = nullish(isClozeDeletion, false);
      this.paIndicator = nullish(paIndicator, null);
    }

    run() {
      let sentences = document.querySelectorAll(".expression--sentence")

      if (sentences !== null) {
        for (let sent of sentences) {
          processSentence(sent, this.isAltDisplay, this.isClozeDeletion, this.paIndicator);
        }
      }
    }
  }


  return JPMNSentUtils;

})();


/// 

























// a general function to implement all keybinds necessary by the card.
// NOTICE: we MUST use document.onkeyup instead of document.addEventListener(...)
// because functions persist and cannot be easily removed within anki,
// whereas .onkeyup = ... replaces the previous function with the current.
document.onkeyup = (e => {
  let keys = null;
  let ele = null;

  // START_BLOCK: js_keybind_settings






  keys = getSetting(['keybinds','toggle-hybrid-sentence',],['n']);
  if (keys !== null && keys.includes(e.key)) {
    let hSent = document.getElementById("hybrid-sentence");
    let hWord = document.getElementById("hybrid-word");
    if (hSent !== null && hWord !== null) {
      hybridClick();
    }
  }

  keys = getSetting(['keybinds','toggle-highlight-word',],['n']);
  if (keys !== null && keys.includes(e.key)) {
    let paButton = document.getElementById("pa-button");
    if (paButton !== null) {
      toggleHighlightWord();
    }
  }

  /// 
  /// 

  // END_BLOCK: js_keybind_settings














  if (e.getModifierState && e.getModifierState('CapsLock')) {
    if (e.key === "CapsLock") {
      // either just enabled or disabled, not sure which one is which
      // it seems like normal browsers can't reach this point during (caps lock enabled -> caps lock disabled...)
      LOGGER.removeWarn("caps");
    } else if (!["Meta"].includes(e.key)) {
      LOGGER.debug(e.key);
      LOGGER.warn("Caps lock is enabled. Keybinds may not work as expected.", true, "caps")
    }
  } else {
    LOGGER.removeWarn("caps");
  }


  /// {{#WordAudio}}
  keys = getSetting(['keybinds','play-word-audio',],['w']);

  if (keys !== null && keys.includes(e.key)) {
    ele = document.querySelector("#word-audio .soundLink, #word-audio .replaybutton");
    if (ele) {
      ele.click();
    }
  }
  /// {{/WordAudio}}

  /// {{#SentenceAudio}}
  keys = getSetting(['keybinds','play-sentence-audio',],['p']);
  if (keys !== null && keys.includes(e.key)) {

    let hSent = document.getElementById("hybrid-sentence");

    /// 
    if (getSetting(['hybrid-sentence-open-on-play-sentence',],true)
        && '{{#IsHoverCard}}FILLED{{/IsHoverCard}}{{#IsClickCard}}FILLED{{/IsClickCard}}'
        && '{{#IsTargetedSentenceCard}}FILLED{{/IsTargetedSentenceCard}}{{#IsSentenceCard}}FILLED{{/IsSentenceCard}}'
        && hSent !== null && !hSent.classList.contains("override-display-inline-block")) {
      hybridClick();
    } else {
    /// 
      ele = document.querySelector("#sentence-audio .soundLink, #sentence-audio .replaybutton");
      if (ele) {
        ele.click();
      }
    /// 
    }
    /// 
  }
  /// {{/SentenceAudio}}

  keys = getSetting(['keybinds','toggle-front-full-sentence-display',],["'"]);
  ele = document.getElementById("full_sentence_front_details");
  if (keys !== null && ele && keys.includes(e.key)) {
    toggleDetailsTag(ele)
  }

  /// {{#Hint}}
  keys = getSetting(['keybinds','toggle-hint-display',],['.']);
  ele = document.getElementById("hint_details");
  if (keys !== null && ele && keys.includes(e.key)) {
    toggleDetailsTag(ele)
  }
  /// {{/Hint}}

  ///  

})
///  


function main() {

  // sanity check: options
  /// 
  if (typeof JPMNOpts === 'undefined') {
    LOGGER.warn("JPMNOpts was not defined in the options file. Was there an error?");
  }
  ///  

  // sanity check: checks that both `IsHoverCard` and `IsClickCard` are both not activated
  /// {{#IsHoverCard}}
  /// {{#IsClickCard}}
  LOGGER.warn("Both `IsHoverCard` and `IsClickCard` are filled. At most one should be filled at once.");
  /// {{/IsClickCard}}
  /// {{/IsHoverCard}}

  // START_BLOCK: js_run







  // required for the sentence utils module
  var paIndicator;

  /// {{#PAShowInfo}}
  var paIndicator = (function () {
    let my = {};
    my.type = null;
    my.className = null;
    my.tooltip = null;

    if ('{{#PADoNotTest}}FILLED{{/PADoNotTest}}{{#PASeparateWordCard}}FILLED{{/PASeparateWordCard}}') {
      my.type = "none";
    } else if ('{{#PASeparateSentenceCard}}FILLED{{/PASeparateSentenceCard}}{{#PATestOnlyWord}}FILLED{{/PATestOnlyWord}}') {
      my.type = "word";
    } else if ('{{#IsSentenceCard}}FILLED{{/IsSentenceCard}}') {
      my.type = "sentence";
    } else {
      my.type = "word";
    }

    my.className = "pa-indicator-color--" + my.type;

    if (my.type === "none") {
      my.tooltip = "Do not test"
    } else if (my.type == "word") {
      my.tooltip = "Word"
    } else { // sentence
      my.tooltip = "Sentence"
    }

    return my;
  }());
  /// {{/PAShowInfo}}

  {

    /// {{#IsClickCard}}
    let d = document.getElementById("display");
    d.onclick = hybridClick;
    /// {{/IsClickCard}}


    /// {{#PAShowInfo}}
    // ============================
    //  Word pitch indicator color
    // ============================
    // done in javascript to simplify templating logic
    let circ = document.getElementById("pa_indicator_circle");
    let svgTitle = document.getElementById("svg_title");

    if (svgTitle !== null) {
      svgTitle.textContent = "PA: " + paIndicator.tooltip;
    }

    circ.classList.add(paIndicator.className);
    /// {{/PAShowInfo}}
  }
  /// 

  /// {{#PAShowInfo}}
  {
    let paButton = document.getElementById("pa-button");
    let d = document.getElementById("display");
    if (paButton !== null) {
      paButton.onclick = () => {
        if (paButton.innerText == "Show") {
          paButton.innerText = "Hide";
          d.classList.add("highlight-bold");
        } else {
          paButton.innerText = "Show";
          if (d.classList.contains("highlight-bold")) {
            d.classList.remove("highlight-bold");
          }
        }
      }
    }
  }
  /// {{/PAShowInfo}}

  /// 

  // END_BLOCK: js_run



  try { // RUN: sent-utils
    
        
    if (getSetting(['modules','sent-utils','enabled',],true)) {

      let isAltDisplay = !!'{{#AltDisplay}}FILLED{{/AltDisplay}}';
      let sent_utils = new JPMNSentUtils(isAltDisplay, false, paIndicator);
      sent_utils.run();

    }
    /// 
        
  } catch (error) {
    LOGGER.error("Error in module sent-utils:");
    LOGGER.errorStack(error.stack);
  }












}



main();



}());

</script>



