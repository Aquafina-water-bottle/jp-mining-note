





<script>

var logger = (function (my) {
  let uniqueKeys = new Set();

  let _appendMsg = function(message, groupEle, key=null) {
    // I think this stops an infinite loop somewhere if you log a null for some reason...
    if (message === null) {
      message = "null";
    }

    let msgEle = document.createElement('div');
    msgEle.classList.add("info-circle__message")
    if (key !== null) {
      msgEle.setAttribute("data-key", key);
    }

    if (Array.isArray(message)) {
      if (message.length > 0) {
        msgEle.textContent = message[0];

        for (let line of message.slice(1)) {
          let lineEle = document.createElement('div');
          lineEle.textContent = line;
          msgEle.appendChild(lineEle);
        }
      }

    } else {
      msgEle.textContent = message;
    }
    groupEle.appendChild(msgEle);
  }

  my.error = function(message) {
    let groupEle = document.getElementById("info_circle_text_error");
    _appendMsg(message, groupEle);
    let infoCirc = document.getElementById("info_circle");
    if (!infoCirc.classList.contains("info-circle-error")) {
      infoCirc.classList.add("info-circle-error")
    }
  }

  my.assert = function(condition, message) {
    if (!condition) {
      my.error("(assert) " + message);
    }
  }

  my.removeWarn = function(key) {
    // assumes that this is a unique warn message

    if (!uniqueKeys.has(key)) {
      return;
    }

    let groupEle = document.getElementById("info_circle_text_warning");
    for (let e of groupEle.children) {
      if (e.getAttribute("data-key") === key) {
        groupEle.removeChild(e);
      }
    }

    let infoCirc = document.getElementById("info_circle");
    if (groupEle.children.length === 0 && infoCirc.classList.contains("info-circle-warning")) {
      infoCirc.classList.remove("info-circle-warning")
    }

    uniqueKeys.delete(key);
  }

  // key defaults to the message if unique is true and key is null
  // key is ignored if unique == false
  my.warn = function(message, unique=true, key=null) {

    // skips any non-unique warns as defined by the key
    if (unique) {
      if (key === null) {
        key = message;
      }

      if (uniqueKeys.has(key)) {
        return;
      }
    }

    let groupEle = document.getElementById("info_circle_text_warning");
    _appendMsg(message, groupEle, key);
    let infoCirc = document.getElementById("info_circle");
    if (!infoCirc.classList.contains("info-circle-warning")) {
      infoCirc.classList.add("info-circle-warning")
    }

    if (key !== null) {
      uniqueKeys.add(key);
    }

  }

  my.info = function(message) {
    let groupEle = document.getElementById("info_circle_text_info");
    _appendMsg(message, groupEle);
  }


  my.leech = function() {
    let groupEle = document.getElementById("info_circle_text_leech");
    _appendMsg("", groupEle);
    let infoCirc = document.getElementById("info_circle");
    if (!infoCirc.classList.contains("info-circle-leech")) {
      infoCirc.classList.add("info-circle-leech")
    }
  }

  return my;
}(logger || {}));



// on any javascript error: log it
window.onerror = function(msg, url, lineNo, columnNo, error) {
//window.onerror = function(msg) {
  //logger.error("Javascript error: `" + msg + "`" + "\n" + error.stack);
  let stackList = error.stack.split(" at ");
  for (let i = 1; i < stackList.length; i++) {
    stackList[i] = ">>> " + stackList[i];
  }
  logger.error(stackList);
}

// https://stackoverflow.com/a/55178672
window.onunhandledrejection = function(errorEvent) {
  logger.error("Javascript handler error: `" + errorEvent.reason + "`");
}


function optionsNotFound() {
  logger.warn("Options file not found. Did you place the options file in the media directory?");
}



</script>

<script onerror="optionsNotFound();" src="_jpmn-options.js"></script>


<div class="card-description">
  

    

    


  {{#IsHoverCard}}
    Hover ({{#IsSentenceCard}}Sentence{{/IsSentenceCard}}{{^IsSentenceCard}}Word{{/IsSentenceCard}})
  {{/IsHoverCard}}


  {{^IsHoverCard}}

    {{#IsClickCard}}
      Click ({{#IsSentenceCard}}Sentence{{/IsSentenceCard}}{{^IsSentenceCard}}Word{{/IsSentenceCard}})
    {{/IsClickCard}}

    {{^IsClickCard}}
      {{#IsTargetedSentenceCard}}
        TSC
      {{/IsTargetedSentenceCard}}
      {{^IsTargetedSentenceCard}}
        {{#IsSentenceCard}}
          Sentence
        {{/IsSentenceCard}}
        {{^IsSentenceCard}}
          Word
        {{/IsSentenceCard}}
      {{/IsTargetedSentenceCard}}  
    {{/IsClickCard}}  
  {{/IsHoverCard}} 

  {{#PAShowInfo}}

    /

    <!-- PADoNotTest or PASeparateWordCard == none -->
    
    
      {{#PADoNotTest}}{{^PASeparateWordCard}}
      None
    {{/PASeparateWordCard}}{{/PADoNotTest}}
      {{^PADoNotTest}}{{#PASeparateWordCard}}
      None
    {{/PASeparateWordCard}}{{/PADoNotTest}}
      {{#PADoNotTest}}{{#PASeparateWordCard}}
      None
    {{/PASeparateWordCard}}{{/PADoNotTest}}


    <!-- neither PADoNotTest, PASeparateWordCard are filled -->
    <!-- we then test the PA somewhere -->
    {{^PADoNotTest}}{{^PASeparateWordCard}}

      <!-- PASeparateSentenceCard or PATestOnlyWord == word -->
      
    
      {{#PASeparateSentenceCard}}{{^PATestOnlyWord}}
        Word
      {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}
      {{^PASeparateSentenceCard}}{{#PATestOnlyWord}}
        Word
      {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}
      {{#PASeparateSentenceCard}}{{#PATestOnlyWord}}
        Word
      {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}


      <!-- if none of the above, then we test the default value -->
      {{^PASeparateSentenceCard}}{{^PATestOnlyWord}}

        <!-- note: default for TSC is test word, may change in the future... -->
        {{#IsSentenceCard}}
          Sentence
        {{/IsSentenceCard}}
        {{^IsSentenceCard}}
          Word
        {{/IsSentenceCard}}

      {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}

    {{/PASeparateWordCard}}{{/PADoNotTest}}

  {{/PAShowInfo}} 




    
  <span class="info-circle" id="info_circle">
    <span class="info-circle-svg-wrapper">
      <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" class="bi bi-info-circle" viewBox="0 0 16 16">
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
      </svg>
    </span>

    <span class="info-circle-text-wrapper">
      <span class="info-circle-text" id="info_circle_text">
        <div class="info-circle-text-error" id="info_circle_text_error"></div>
        <div class="info-circle-text-warning" id="info_circle_text_warning"></div>
        <div class="info-circle-text-leech" id="info_circle_text_leech"></div>
        <div class="info-circle-text-info" id="info_circle_text_info">
          <div>
            Need help? View the
            <a href="https://github.com/Aquafina-water-bottle/jp-mining-note/wiki">documentation</a>.
          </div>
          <div>
            Have an issue?
            <a href="https://github.com/Aquafina-water-bottle/jp-mining-note/issues">Report it here</a>.
          </div>
          <div>
            View the
            <a href="https://github.com/Aquafina-water-bottle/jp-mining-note">source code</a>.
          </div>
        </div>
      </span>
    </span>
  </span>


    
  <div class="card-description-ver">JP Mining Note: Version 0.9.1.1</div>


    
</div>







<!-- legacy display -->
{{^PAShowInfo}}

  <!-- priority is on the alternate display sentence -->

  {{#IsHoverCard}}
    <!-- fallback card card html
      in css: default hybrid css, but with hover instead of click -->
    <div class="expression__hybrid-wrapper">
      <div class="expression expression--single expression__hybrid expression__hybrid--hover" id="Display">
        <span class="expression--sentence expression__hybrid-sentence expression
                   {{^IsSentenceCard}} bold-yellow {{/IsSentenceCard}}
                   {{#IsTargetedSentenceCard}} bold-yellow {{/IsTargetedSentenceCard}}
                   "
              id="hybrid-sentence">
          <span class="sentence-quote sentence-quote--open">「</span><span>{{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Sentence}}{{/AltDisplay}}</span><span class="sentence-quote sentence-quote--close">」</span>
        </span>
        <span class="expression--word expression__hybrid-word
            {{#IsTargetedSentenceCard}} expression__hybrid-word--sentence-underline {{/IsTargetedSentenceCard}}
            {{^IsTargetedSentenceCard}}
              {{#IsSentenceCard}} expression__hybrid-word--sentence-underline {{/IsSentenceCard}}
              {{^IsSentenceCard}} expression__hybrid-word--word-underline {{/IsSentenceCard}}
            {{/IsTargetedSentenceCard}}
            expression__hybrid-word--hover-indicator"
            id="hybrid-word">
          {{Word}}
        </span>
      </div>
    </div>
  {{/IsHoverCard}} 

  {{^IsHoverCard}}

    {{#IsClickCard}}
      <!-- hybrid (sentence or word) card html
        in css: default hybrid css, with click -->
      <div class="expression__hybrid-wrapper">
        <div class="expression expression--single expression__hybrid expression__hybrid--click" id="Display">
          <span class="expression--sentence expression__hybrid-sentence
                    {{^IsSentenceCard}} bold-yellow {{/IsSentenceCard}}
                    {{#IsTargetedSentenceCard}} bold-yellow {{/IsTargetedSentenceCard}}
                    "
                id="hybrid-sentence">
            <span class="sentence-quote sentence-quote--open">「</span><span>{{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Sentence}}{{/AltDisplay}}</span><span class="sentence-quote sentence-quote--close">」</span>
          </span>
          <span class="expression--word expression__hybrid-word
                {{#IsTargetedSentenceCard}} expression__hybrid-word--sentence-underline {{/IsTargetedSentenceCard}}
                {{^IsTargetedSentenceCard}}
                  {{#IsSentenceCard}} expression__hybrid-word--sentence-underline {{/IsSentenceCard}}
                  {{^IsSentenceCard}} expression__hybrid-word--word-underline {{/IsSentenceCard}}
                {{/IsTargetedSentenceCard}}
              expression__hybrid-word--click-indicator"
              id="hybrid-word">
            {{Word}}
          </span>
        </div>
      </div>
    {{/IsClickCard}} 


    {{^IsClickCard}}

      {{#IsTargetedSentenceCard}}
        <div class="expression expression--sentence expression--single bold-yellow" id="Display">
          <span class="sentence-quote sentence-quote--open">「</span><span>{{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Sentence}}{{/AltDisplay}}</span><span class="sentence-quote sentence-quote--close">」</span>
        </div>
      {{/IsTargetedSentenceCard}}

      {{^IsTargetedSentenceCard}}
        {{#IsSentenceCard}}
          <div class="expression expression--sentence expression--single" id="Display">
            <span class="sentence-quote sentence-quote--open">「</span><span>{{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Sentence}}{{/AltDisplay}}</span><span class="sentence-quote sentence-quote--close">」</span>
          </div>
        {{/IsSentenceCard}}

        {{^IsSentenceCard}}
          <div class="expression expression--word expression--single" id="Display">
            {{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Word}}{{/AltDisplay}}
          </div>
        {{/IsSentenceCard}}
      {{/IsTargetedSentenceCard}} 

    {{/IsClickCard}} 

  {{/IsHoverCard}} 

{{/PAShowInfo}} 


<!-- regular display -->
{{#PAShowInfo}}
  <div class="expression expression-box">

    <!-- priority is on the alternate display sentence -->


    {{#IsHoverCard}}
      <!-- fallback card card html
        in css: default hybrid css, but with hover instead of click -->
      <div class="expression__hybrid-wrapper">
        <div class="expression expression__hybrid expression__hybrid--hover" id="Display">
          <span class="expression--sentence expression__hybrid-sentence
                       {{^IsSentenceCard}} bold-yellow {{/IsSentenceCard}}
                       {{#IsTargetedSentenceCard}} bold-yellow {{/IsTargetedSentenceCard}}
                       "
                id="hybrid-sentence">
            <span class="sentence-quote sentence-quote--open">「</span><span>{{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Sentence}}{{/AltDisplay}}</span><span class="sentence-quote sentence-quote--close">」</span>
          </span>
          <span class="expression--word expression__hybrid-word
              {{#IsTargetedSentenceCard}} expression__hybrid-word--sentence-underline {{/IsTargetedSentenceCard}}
              {{^IsTargetedSentenceCard}}
                {{#IsSentenceCard}} expression__hybrid-word--sentence-underline {{/IsSentenceCard}}
                {{^IsSentenceCard}} expression__hybrid-word--word-underline {{/IsSentenceCard}}
              {{/IsTargetedSentenceCard}}
              expression__hybrid-word--hover-indicator"
              id="hybrid-word">
            {{Word}}
          </span>
        </div>

      </div>

    {{/IsHoverCard}} 

    {{^IsHoverCard}}

      {{#IsClickCard}}
        <!-- hybrid (sentence or word) card html
          in css: default hybrid css, with click -->
        <div class="expression__hybrid-wrapper">
          <div class="expression expression__hybrid expression__hybrid--click" id="Display">
            <span class="expression--sentence expression__hybrid-sentence
                      {{^IsSentenceCard}} bold-yellow {{/IsSentenceCard}}
                      {{#IsTargetedSentenceCard}} bold-yellow {{/IsTargetedSentenceCard}}
                      "
                  id="hybrid-sentence">
              <span class="sentence-quote sentence-quote--open">「</span><span>{{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Sentence}}{{/AltDisplay}}</span><span class="sentence-quote sentence-quote--close">」</span>
            </span>
            <span class="expression--word expression__hybrid-word
                {{#IsTargetedSentenceCard}} expression__hybrid-word--sentence-underline {{/IsTargetedSentenceCard}}
                {{^IsTargetedSentenceCard}}
                  {{#IsSentenceCard}} expression__hybrid-word--sentence-underline {{/IsSentenceCard}}
                  {{^IsSentenceCard}} expression__hybrid-word--word-underline {{/IsSentenceCard}}
                {{/IsTargetedSentenceCard}}
                expression__hybrid-word--click-indicator"
                id="hybrid-word">
              {{Word}}
            </span>
          </div>
        </div>
      {{/IsClickCard}} 

      {{^IsClickCard}}

        {{#IsTargetedSentenceCard}}
          <div class="expression expression--sentence bold-yellow" id="Display">
            <span class="sentence-quote sentence-quote--open">「</span><span>{{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Sentence}}{{/AltDisplay}}</span><span class="sentence-quote sentence-quote--close">」</span>
          </div>
        {{/IsTargetedSentenceCard}}

        {{^IsTargetedSentenceCard}}
          {{#IsSentenceCard}}
            <div class="expression expression--sentence" id="Display">
              <span class="sentence-quote sentence-quote--open">「</span><span>{{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Sentence}}{{/AltDisplay}}</span><span class="sentence-quote sentence-quote--close">」</span>
            </div>
          {{/IsSentenceCard}}

          {{^IsSentenceCard}}
            <div class="expression expression--word" id="Display">
              {{#AltDisplay}}{{furigana:AltDisplay}}{{/AltDisplay}}{{^AltDisplay}}{{Word}}{{/AltDisplay}}
            </div>
          {{/IsSentenceCard}}
        {{/IsTargetedSentenceCard}} 

      {{/IsClickCard}} 

    {{/IsHoverCard}} 


    <!-- appears to the left -->
    <div class="flag-box">
      <svg xmlns="http://www.w3.org/2000/svg" focusable="false" viewBox="0 0 50 50"
        class="flag-box__svg" id="flag_box_svg">
        <circle id="svg_circle" class="flag-box__circle" cx="25" cy="15" r="7">
          <title id=svg_title></title>
        </circle>
      </svg>
    </div>

  </div> <!-- expression box -->

{{/PAShowInfo}} 



{{#HintNotHidden}}
  <div class="center-box-1 hint">
    <div class="center-box-2">
      <div class="bold-yellow">{{HintNotHidden}}</div>
    </div>
  </div>
{{/HintNotHidden}}

<!-- https://stackoverflow.com/questions/1269589/css-center-block-but-align-contents-to-the-left -->
<!-- tl;dr wrap anything you want centered + left justified with center-box-1 and center-box-2 -->
{{#Hint}}
  <details class="hint" id="hint_details">
    <summary>Hint</summary>
    <div class="center-box-1">
      <div class="center-box-2">
        <div class="bold-yellow">{{Hint}}</div>
      </div>
    </div>
  </details>
{{/Hint}}






<!-- regular display -->
<!-- displays the audio and show/hide button, used only when testing pitch accent -->
{{#PAShowInfo}}

  <!-- only shown if:
    - word PA should be tested
    - sentence card
      - TSC and hybrid cards already shows the word
  -->
  {{#IsSentenceCard}}
  {{^PADoNotTest}}{{^PASeparateWordCard}}{{^IsTargetedSentenceCard}}{{^IsClickCard}}{{^IsHoverCard}}

  
  
    {{#PASeparateSentenceCard}}{{^PATestOnlyWord}}
    <button id="pa-button">Show</button>

  {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}
    {{^PASeparateSentenceCard}}{{#PATestOnlyWord}}
    <button id="pa-button">Show</button>

  {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}
    {{#PASeparateSentenceCard}}{{#PATestOnlyWord}}
    <button id="pa-button">Show</button>

  {{/PATestOnlyWord}}{{/PASeparateSentenceCard}}

  {{/IsHoverCard}}{{/IsClickCard}}{{/IsTargetedSentenceCard}}{{/PASeparateWordCard}}{{/PADoNotTest}}
  {{/IsSentenceCard}}

  <!--
    if the display is a word: show sentence preview (spoilered)
  -->
  {{^IsSentenceCard}}{{^IsHoverCard}}{{^IsClickCard}}{{^IsTargetedSentenceCard}}
    
        
    <details class="glossary-details" id="full_sentence_front_details">
      <summary>Full Sentence</summary>
      <div class="center-box-1">
        <div class="center-box-2">
          <div class="full-sentence bold-yellow" id="full_sentence_front">
            {{furigana:SentenceReading}}
          </div>
        </div>
      </div>
    </details>

        
  {{/IsTargetedSentenceCard}}{{/IsClickCard}}{{/IsHoverCard}}{{/IsSentenceCard}}

  
    

  <span id="pa-silence-audio" style="display:none">{{PASilence}}</span>

  {{#SentenceAudio}}
    <span id="sentence-audio"> {{SentenceAudio}} </span>
  {{/SentenceAudio}}



  <script>
    // THIS IS A HACK: this hack is to not auto-play the audio at the front of the card
    // https://forums.ankiweb.net/t/disabling-audio-autoplay-for-certain-fields/6318/3
    // https://forums.ankiweb.net/t/controlling-display-and-function-of-audio-buttons/10234
    var elem = document.querySelector("#pa-silence-audio .soundLink, #pa-silence-audio .replaybutton");
    if (elem) {
      elem.click();
    }
  </script>




    

{{/PAShowInfo}} 





<script>



/// 

// import settings as a global variable
// https://forums.ankiweb.net/t/how-to-include-external-files-in-your-template-js-css-etc-guide/11719

//function getAnkiPrefix() {
//  // TODO cross-platform support
//  // "https://appassets.androidplatform.net" ?
//  return "./";
//}
//
//var OPTIONS_FILE = "jp-mining-note-options.js"; // const screws up anki for some reason lol

// import statements cannot be contained in a function, if statement, etc.
//import {createOptions} from getAnkiPrefix() + OPTIONS_FILE;

//import {createOptions} from "./jp-mining-note-options.js";



// global cache for an entire card's kanji hover html
// maps key.word_reading -> html string
var kanjiHoverCardCache = kanjiHoverCardCache ?? {};

// maps kanji -> [{set of used words}, html string]
var kanjiHoverCache = kanjiHoverCache ?? {};

// note that this cache will NOT respect card review undos,
// but that should be a niche enough case to not warrent caching.
// maps key -> bool
var isNewCardCache = isNewCardCache ?? {};

(function () { // restricts ALL javascript to hidden scope

// "global" variables within the hidden scope
let note = (function () {
  let my = {};
  my.colorQuotes = false;
  return my;
}());



function getSetting(keys, defaultVal) {
  if (typeof JPMNOpts === "undefined") {
    return defaultVal;
  }

  let keyList = ["settings"].concat(keys);

  let obj = JPMNOpts;
  for (let key of keyList) {
    if (!(key in obj)) {

      // checks if we need to warn, manual search
      if ("settings" in JPMNOpts && "debug" in JPMNOpts["settings"] && JPMNOpts["settings"]["debug"]) {
        logger.warn("Option " + keys.join(".") + " is not defined in the options file.");
      }
      return defaultVal;
    }
    obj = obj[key];
  }
  return obj;
};


function _debug(message) {
  if (getSetting(['debug',],false)) {
    logger.info(message);
  }
}



// global variable to set the PA indicator color (as a css class)
/// {{#PAShowInfo}}
var paIndicator = (function () {
  let my = {};
  my.type = null;
  my.className = null;
  my.tooltip = null;

  if ('{{#PADoNotTest}}a{{/PADoNotTest}}{{#PASeparateWordCard}}a{{/PASeparateWordCard}}') {
    my.type = "none";
  } else if ('{{#PASeparateSentenceCard}}a{{/PASeparateSentenceCard}}{{#PATestOnlyWord}}a{{/PATestOnlyWord}}') {
    my.type = "word";
  } else if ('{{#IsSentenceCard}}a{{/IsSentenceCard}}') {
    my.type = "sentence";
  } else {
    my.type = "word";
  }

  my.className = "pa-indicator-color--" + my.type;

  if (my.type === "none") {
    my.tooltip = "Do not test"
  } else if (my.type == "word") {
    my.tooltip = "Word"
  } else { // sentence
    my.tooltip = "Sentence"
  }

  return my;
}());
/// {{/PAShowInfo}} // PAShowInfo


/// 


/*
 * processes the sentence (if there is no altdisplay)
 * - removes newlines
 * - replaces bold with [...] if cloze deletion
 * - handles adding or replacing quotes if specified
 *
 * isAltDisplay=false
 */
function processSentence(sentEle, isAltDisplay, isClozeDeletion) {
  if (!getSetting(['sentence','enabled',],true)) {
    return;
  }

  if (typeof isAltDisplay === 'undefined') {
    logger.warn("isAltDisplay is undefined");
    isAltDisplay = false;
  }

  // removes linebreaks
  let result = sentEle.children[1].innerHTML;

  // cloze deletion replacing bold with [...]
  if (typeof isClozeDeletion !== "undefined" && isClozeDeletion) {
    result = result.replace(/<b>.*?<\/b>/g, "<b>[...]</b>");
  }

  if ((!isAltDisplay && getSetting(['sentence','remove-line-breaks',],false))
      || isAltDisplay && getSetting(['sentence','remove-line-breaks-on-altdisplay',],false)) {
    let noNewlines = result.replace(/<br>/g, "");

    // automatically removes newlines and other html elements
    // https://stackoverflow.com/a/54369605
    //let charCount = [...sentEle.innerText.trim()].length;
    //let maxCharCount = { utils.opt("sentence", "remove-line-breaks-until-char-count") }

    //if ((maxCharCount === 0) || (charCount <= maxCharCount)) {
    //  result = noNewlines;
    //}

    result = noNewlines;
  }

  // removes leading and trailing white space (equiv. of strip() in python)
  result = result.trim();

  // selects the smallest containing sentence

  //if (!isAltDisplay && settings.sentence("select-smallest-sentence")) {
  //  result = selectSentence(result);
  //}

  //if (settings.quote("enabled", true)) {
  //  result = processQuote(sentEle, result, isAltDisplay);
  //} else {
  //  sentEle.innerHTML = result;
  //}

  //var processQuote = function(sentEle, sent, isAltDisplay) {
  //let result = sent;

  //let openQuote = null;
  //let closeQuote = null;
  //let validQuotes = settings.quote("quote-match-strings", [["「", "」"]])


  // if existing quotes:
  //     remove from sentence
  //     add to quote spans
  // if no existing quotes and if autoquote:
  //     add autoquote open / close to quote spans (if different)
  // if color quotes:
  //     add color quote class to outer divs
  

  let validQuotes = getSetting(['sentence','quote-match-strings',],[['「', '」'], ['『', '』']]);
  let existingQuote = false;

  let openQuoteEle = sentEle.children[0];
  let closeQuoteEle = sentEle.children[2];

  for (let quotePair of validQuotes) {
    if ((result[0] === quotePair[0]) && (result[result.length-1] === quotePair[1])) {

      // adds quote to surrounding divs
      let openQuote = null;
      let closeQuote = null;
      [openQuote, closeQuote] = quotePair;
      openQuoteEle.innerText = openQuote;
      closeQuoteEle.innerText = closeQuote;

      result = result.slice(1, -1);
      existingQuote = true;
      break;
    }
  }

  let autoQuote = (
    (!isAltDisplay && getSetting(['sentence','auto-quote-sentence',],true))
    || (isAltDisplay && getSetting(['sentence','auto-quote-alt-display-sentence',],true))
  );
  if (!existingQuote && autoQuote) {
    /// 
    openQuoteEle.innerText = getSetting(['sentence','auto-quote-open',],'「');
    closeQuoteEle.innerText = getSetting(['sentence','auto-quote-close',],'」');
    /// 
  }

  // no quotes are added
  if (!existingQuote && !autoQuote) {
    // defaults to having quotes, in case javascript fails to load for some reason
    openQuoteEle.innerText = "";
    closeQuoteEle.innerText = "";

    sentEle.style["text-indent"] = "0em";
    sentEle.style["padding-left"] = "0em";
  }


  /// 

  /// 
  /// {{#PAShowInfo}}
  if ((existingQuote || autoQuote) && getSetting(['sentence','pa-indicator-color-quotes',],false)) {
    note.colorQuotes = true;
    openQuoteEle.classList.add(paIndicator.className);
    closeQuoteEle.classList.add(paIndicator.className);

    /// {{#IsHoverCard}}
    let elems = document.getElementsByClassName("expression__hybrid-wrapper");
    if (elems.length > 0) {
      elems[0].classList.add("expression__hybrid-wrapper--hover-remove-flag");
    }
    /// {{/IsHoverCard}}

    // neither hover & click and is either one of TSC / sentence -> removes flag

    /// ///{{^IsHoverCard}}///{{^IsClickCard}}
    /// 
  
    ///{{#IsTargetedSentenceCard}}///{{^IsSentenceCard}}
    let svgEle = document.getElementById("flag_box_svg");
    svgEle.style.display = "none";
    /// ///{{/IsSentenceCard}}///{{/IsTargetedSentenceCard}}
    ///{{^IsTargetedSentenceCard}}///{{#IsSentenceCard}}
    let svgEle = document.getElementById("flag_box_svg");
    svgEle.style.display = "none";
    /// ///{{/IsSentenceCard}}///{{/IsTargetedSentenceCard}}
    ///{{#IsTargetedSentenceCard}}///{{#IsSentenceCard}}
    let svgEle = document.getElementById("flag_box_svg");
    svgEle.style.display = "none";
    /// ///{{/IsSentenceCard}}///{{/IsTargetedSentenceCard}}

    /// ///{{/IsClickCard}}///{{/IsHoverCard}}
  }
  /// {{/PAShowInfo}}
  /// 

  sentEle.children[1].innerHTML = result;
}

/*
 * Toggles the display of any given details tag
 */
function toggleDetailsTag(ele) {
  if (ele.hasAttribute('open')) {
    ele.removeAttribute('open');
  } else {
    ele.setAttribute("open", "true");
  }
}


function processSentences(isAltDisplay, isClozeDeletion) {
  let sentences = document.querySelectorAll(".expression--sentence")

  if (sentences !== null) {
    for (let sent of sentences) {
      processSentence(sent, isAltDisplay, isClozeDeletion);
    }
  }
}


///  /// note.card_type != "pa_word"



/// 

/// 

function hybridClick() {
  let hSent = document.getElementById("hybrid-sentence");
  let hWord = document.getElementById("hybrid-word");
  let svgEle = document.getElementById("flag_box_svg");
  let circ = document.getElementById("svg_circle");


  if (hSent.classList.contains("override-display-inline-block")) {
    // currently showing sentence, change to word
    hWord.classList.remove("override-display-none");
    hSent.classList.remove("override-display-inline-block");
    if (circ !== null) {
      circ.setAttributeNS(null, "cx", "25");
      circ.setAttributeNS(null, "cy", "15");
    }
    // re-adds if quote module enabled
    if (svgEle !== null && note.colorQuotes) {
      svgEle.style.display = "initial";
    }

  } else {
    // currently showing word, change to sentence
    hWord.classList.add("override-display-none");
    hSent.classList.add("override-display-inline-block");
    if (circ !== null) { // sentence
      if (hSent.innerText.length > 0 && hSent.innerText[0] === "「") {
        circ.setAttributeNS(null, "cx", "35");
        circ.setAttributeNS(null, "cy", "11");
      }
    }
    // removes if quote module enabled
    if (svgEle !== null && note.colorQuotes) {
      svgEle.style.display = "none";
    }
  }
}

/// 

function toggleHighlightWord() {
  let paButton = document.getElementById("pa-button");
  let d = document.getElementById("Display");

  if (paButton.innerText == "Show") {
    paButton.innerText = "Hide";
    d.classList.add("bold-yellow");
  } else {
    paButton.innerText = "Show";
    if (d.classList.contains("bold-yellow")) {
      d.classList.remove("bold-yellow");
    }
  }
}

/// 





// shift to switch between sentence & word on click & hover cards
// NOTICE: we MUST use document.onkeyup instead of document.addEventListener(...)
// because functions persist and cannot be easily removed within anki,
// whereas .onkeyup = ... replaces the previous function with the current.
document.onkeyup = (e => {
  let keys = null;
  let ele = null;

  // tests for the existance of extraKeybindSettings
  //if (typeof extraKeybindSettings !== 'undefined') {
  //  extraKeybindSettings(e);
  //}

  /// 
    /// 

    /// 


  //keys = settings.keybind("toggle-hybrid-sentence");
  keys = getSetting(['keybinds','toggle-hybrid-sentence',],['n']);
  if (keys !== null && keys.includes(e.key)) {
    let hSent = document.getElementById("hybrid-sentence");
    let hWord = document.getElementById("hybrid-word");
    if (hSent !== null && hWord !== null) {
      hybridClick();
    }
  }

  //keys = settings.keybind("toggle-highlight-word");
  keys = getSetting(['keybinds','toggle-highlight-word',],['n']);
  if (keys !== null && keys.includes(e.key)) {
    let paButton = document.getElementById("pa-button");
    if (paButton !== null) {
      toggleHighlightWord();
    }
  }

  /// 
  /// 
    /// 




  if (e.getModifierState && e.getModifierState('CapsLock')) {
    if ("CapsLock" === e.key) {
      // either just enabled or disabled
      logger.removeWarn("caps");
    } else {
      logger.warn("Caps lock is enabled. Keybinds may not work as expected.", true, "caps")
    }
  } else {
    //_debug("Caps lock is not enabled");
  }


  /// {{#WordAudio}}
  //keys = settings.keybind("play-word-audio");
  keys = getSetting(['keybinds','play-word-audio',],['w']);

  if (keys !== null && keys.includes(e.key)) {
    ele = document.querySelector("#word-audio .soundLink, #word-audio .replaybutton");
    if (ele) {
      ele.click();
    }
  }
  /// {{/WordAudio}}

  /// {{#SentenceAudio}}
  keys = getSetting(['keybinds','play-sentence-audio',],['p']);
  if (keys !== null && keys.includes(e.key)) {

    let hSent = document.getElementById("hybrid-sentence");

    /// 
    if (getSetting(['hybrid-sentence-open-on-play-sentence',],true)
        && '{{#IsHoverCard}}a{{/IsHoverCard}}{{#IsClickCard}}a{{/IsClickCard}}'
        && '{{#IsTargetedSentenceCard}}a{{/IsTargetedSentenceCard}}{{#IsSentenceCard}}a{{/IsSentenceCard}}'
        && hSent !== null && !hSent.classList.contains("override-display-inline-block")) {
      // this somehow works even when hybridClick is undefined here, woah
      hybridClick();
    } else {
    /// 
      ele = document.querySelector("#sentence-audio .soundLink, #sentence-audio .replaybutton");
      if (ele) {
        ele.click();
      }
    /// 
    }
    /// 
  }
  /// {{/SentenceAudio}}

  keys = getSetting(['keybinds','toggle-front-full-sentence-display',],["'"]);
  ele = document.getElementById("full_sentence_front_details");
  if (keys !== null && ele && keys.includes(e.key)) {
    toggleDetailsTag(ele)
  }

  /// {{#Hint}}
  keys = getSetting(['keybinds','toggle-hint-display',],['.']);
  ele = document.getElementById("hint_details");
  if (keys !== null && ele && keys.includes(e.key)) {
    toggleDetailsTag(ele)
  }
  /// {{/Hint}}

  ///  

})


// sanity check
if (typeof JPMNOpts === 'undefined') {
  logger.warn("JPMNOpts was not defined in the options file. Was there an error?");
}

/// 


/// 

{
  let isAltDisplay = !!'{{#AltDisplay}}a{{/AltDisplay}}';
  processSentences(isAltDisplay);

  let d = document.getElementById("Display");
  let circ = document.getElementById("svg_circle");
  let svgTitle = document.getElementById("svg_title");

  /// {{#IsClickCard}}
  d.onclick = hybridClick;
  /// {{/IsClickCard}}



  /// {{#PAShowInfo}}
  // different circle positions depending on whether it's a sentence or not.
  // More specifically, checks if the first character is "「",
  // and adjusts the position based on that

  if ('{{#IsSentenceCard}}a{{/IsSentenceCard}}{{#IsTargetedSentenceCard}}a{{/IsTargetedSentenceCard}}' &&
      d.innerText.length > 0 && d.innerText[0] == "「") { // TODO: compatability with quote module
    circ.setAttributeNS(null, "cx", "35");
    circ.setAttributeNS(null, "cy", "11");
  }

  // ============================
  //  Word pitch indicator color
  // ============================
  // done in javascript to simplify templating logic
  if (svgTitle !== null) {
    svgTitle.textContent = "PA: " + paIndicator.tooltip;
  }

  circ.classList.add(paIndicator.className);
  /// {{/PAShowInfo}}
}
/// 

/// {{#PAShowInfo}}
{
  let paButton = document.getElementById("pa-button");
  let d = document.getElementById("Display");
  if (paButton !== null) {
    //paButton.oncontextmenu = oncontextmenu = (event) => {
    //  event.preventDefault();
    //};
    paButton.onclick = () => {
      if (paButton.innerText == "Show") {
        paButton.innerText = "Hide";
        d.classList.add("bold-yellow");
      } else {
        paButton.innerText = "Show";
        if (d.classList.contains("bold-yellow")) {
          d.classList.remove("bold-yellow");
        }
      }
    }
  }
}
/// {{/PAShowInfo}}

/// 

//})();


}());

</script>




