{{#PASeparateSentenceCard}} {{#SentenceAudio}}

<script>
  var logger = (function (my) {
    let _appendMsg = function (message, groupEle) {
      let msgEle = document.createElement("div");
      msgEle.classList.add("info-circle__message");
      if (Array.isArray(message)) {
        if (message.length > 0) {
          msgEle.textContent = message[0];

          for (let line of message.slice(1)) {
            let lineEle = document.createElement("div");
            lineEle.textContent = line;
            msgEle.appendChild(lineEle);
          }
        }
      } else {
        msgEle.textContent = message;
      }
      groupEle.appendChild(msgEle);
    };

    my.error = function (message) {
      var groupEle = document.getElementById("info_circle_text_error");
      _appendMsg(message, groupEle);
      var infoCirc = document.getElementById("info_circle");
      if (!infoCirc.classList.contains("info-circle-error")) {
        infoCirc.classList.add("info-circle-error");
      }
    };

    my.assert = function (condition, message) {
      if (!condition) {
        my.error("(assert) " + message);
      }
    };

    my.warn = function (message) {
      var groupEle = document.getElementById("info_circle_text_warning");
      _appendMsg(message, groupEle);
      var infoCirc = document.getElementById("info_circle");
      if (!infoCirc.classList.contains("info-circle-warning")) {
        infoCirc.classList.add("info-circle-warning");
      }
    };

    my.info = function (message) {
      var groupEle = document.getElementById("info_circle_text_info");
      _appendMsg(message, groupEle);
    };

    my.leech = function () {
      var groupEle = document.getElementById("info_circle_text_leech");
      _appendMsg("", groupEle);
      var infoCirc = document.getElementById("info_circle");
      if (!infoCirc.classList.contains("info-circle-leech")) {
        infoCirc.classList.add("info-circle-leech");
      }
    };

    return my;
  })(logger || {});

  // on any javascript error: log it
  window.onerror = function (msg, url, lineNo, columnNo, error) {
    //window.onerror = function(msg) {
    //logger.error("Javascript error: `" + msg + "`" + "\n" + error.stack);
    let stackList = error.stack.split(" at ");
    for (let i = 1; i < stackList.length; i++) {
      stackList[i] = ">>> " + stackList[i];
    }
    logger.error(stackList);
  };

  // https://stackoverflow.com/a/55178672
  window.onunhandledrejection = function (errorEvent) {
    logger.error("Javascript handler error: `" + errorEvent.reason + "`");
  };

  function optionsNotFound() {
    logger.warn(
      "Options file not found. Did you place the options file in the media directory?"
    );
  }
</script>

<script onerror="optionsNotFound();" src="jp-mining-note-options.js"></script>

<div class="card-description">
  PA Sentence

  <span class="info-circle" id="info_circle">
    <span class="info-circle-svg-wrapper">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="15"
        height="15"
        class="bi bi-info-circle"
        viewBox="0 0 16 16"
      >
        <path
          d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"
        />
        <path
          d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"
        />
      </svg>
    </span>

    <span class="info-circle-text-wrapper">
      <span class="info-circle-text" id="info_circle_text">
        <div class="info-circle-text-error" id="info_circle_text_error"></div>
        <div
          class="info-circle-text-warning"
          id="info_circle_text_warning"
        ></div>
        <div class="info-circle-text-leech" id="info_circle_text_leech"></div>
        <div class="info-circle-text-info" id="info_circle_text_info">
          <div>
            Need help? View the
            <a
              href="https://github.com/Aquafina-water-bottle/jp-mining-note/wiki"
              >documentation</a
            >.
          </div>
          <div>
            Have an issue?
            <a
              href="https://github.com/Aquafina-water-bottle/jp-mining-note/issues"
              >Report it here</a
            >.
          </div>
          <div>
            View the
            <a href="https://github.com/Aquafina-water-bottle/jp-mining-note"
              >source code</a
            >.
          </div>
        </div>
      </span>
    </span>
  </span>

  <div class="card-description-ver">JP Mining Note: Version 0.8.1.0</div>
</div>

<!-- note that for the PA separate sentence card, the front is ALWAYS a sentence -->
<!-- priority: AltDisplayPASentenceCard -> AltDisplay -> Sentence -->

<!-- option 1: AltDisplayPASentenceCard -->
{{#AltDisplayPASentenceCard}}
<div class="expression expression--single expression--sentence" id="Display">
  {{furigana:AltDisplayPASentenceCard}}
</div>
{{/AltDisplayPASentenceCard}} {{^AltDisplayPASentenceCard}} {{#AltDisplay}}

<div
  class="outer-display1
          {{^IsClickCard}}{{^IsHoverCard}}{{^IsSentenceCard}}{{^IsTargetedSentenceCard}}
            outer-display2
          {{/IsTargetedSentenceCard}}{{/IsSentenceCard}}{{/IsHoverCard}}{{/IsClickCard}}
          "
  style="display: inline-block"
  id="Display"
>
  <!-- option 2: AltDisplay (only if the original card is a (sentence card or TSC or click or hybrid)) -->
  <!-- if any of (click, hover, sentence, TSC) -->
  <div
    class="expression expression--single expression--sentence inner-display1"
  >
    <span class="sentence-quote sentence-quote--open">「</span
    ><span>{{furigana:AltDisplay}}</span
    ><span class="sentence-quote sentence-quote--close">」</span>
  </div>

  <!-- if none of (click, hover, sentence, TSC) -->
  <div
    class="expression expression--single expression--sentence inner-display2"
  >
    <span class="sentence-quote sentence-quote--open">「</span
    ><span>{{Sentence}}</span
    ><span class="sentence-quote sentence-quote--close">」</span>
  </div>
</div>

{{/AltDisplay}} {{^AltDisplay}}
<div class="expression expression--single expression--sentence" id="Display">
  <span class="sentence-quote sentence-quote--open">「</span
  ><span>{{Sentence}}</span
  ><span class="sentence-quote sentence-quote--close">」</span>
</div>
{{/AltDisplay}} {{/AltDisplayPASentenceCard}} {{#HintNotHidden}}
<div class="center-box-1 hint">
  <div class="center-box-2">
    <div class="bold-yellow">{{HintNotHidden}}</div>
  </div>
</div>
{{/HintNotHidden}}

<!-- https://stackoverflow.com/questions/1269589/css-center-block-but-align-contents-to-the-left -->
<!-- tl;dr wrap anything you want centered + left justified with center-box-1 and center-box-2 -->
{{#Hint}}
<details class="hint" id="hint_details">
  <summary>Hint</summary>
  <div class="center-box-1">
    <div class="center-box-2">
      <div class="bold-yellow">{{Hint}}</div>
    </div>
  </div>
</details>
{{/Hint}}

<script>
  ///

  // import settings as a global variable
  // https://forums.ankiweb.net/t/how-to-include-external-files-in-your-template-js-css-etc-guide/11719

  //function getAnkiPrefix() {
  //  // TODO cross-platform support
  //  // "https://appassets.androidplatform.net" ?
  //  return "./";
  //}
  //
  //var OPTIONS_FILE = "jp-mining-note-options.js"; // const screws up anki for some reason lol

  // import statements cannot be contained in a function, if statement, etc.
  //import {createOptions} from getAnkiPrefix() + OPTIONS_FILE;

  //import {createOptions} from "./jp-mining-note-options.js";

  (function () {
    // restricts ALL javascript to hidden scope

    // TODO remove this at some point and replace with proper checks
    var note = (function () {
      let my = {};
      my.colorQuotes = false;
      return my;
    })();

    var getSetting = function (keys, defaultVal) {
      let keyList = ["settings"].concat(keys);

      let obj = JPMNOpts;
      for (let key of keyList) {
        if (!(key in obj)) {
          logger.warn(
            "Option " + keys.join(".") + " is not defined in the options file."
          );
          return defaultVal;
        }
        obj = obj[key];
      }
      return obj;
    };

    // global variable to set the PA indicator color (as a css class)
    /// {{#PAShowInfo}}
    var paIndicator = (function () {
      let my = {};
      my.type = null;
      my.className = null;
      my.tooltip = null;

      if (
        "{{#PADoNotTest}}a{{/PADoNotTest}}{{#PASeparateWordCard}}a{{/PASeparateWordCard}}"
      ) {
        my.type = "none";
      } else if (
        "{{#PASeparateSentenceCard}}a{{/PASeparateSentenceCard}}{{#PATestOnlyWord}}a{{/PATestOnlyWord}}"
      ) {
        my.type = "word";
      } else if ("{{#IsSentenceCard}}a{{/IsSentenceCard}}") {
        my.type = "sentence";
      } else {
        my.type = "word";
      }

      my.className = "pa-indicator-color--" + my.type;

      if (my.type === "none") {
        my.tooltip = "Do not test";
      } else if (my.type == "word") {
        my.tooltip = "Word";
      } else {
        // sentence
        my.tooltip = "Sentence";
      }

      return my;
    })();
    /// {{/PAShowInfo}} // PAShowInfo

    ///

    /*
     * processes the sentence (if there is no altdisplay)
     * - removes newlines
     * - replaces bold with [...] if cloze deletion
     * - handles adding or replacing quotes if specified
     *
     * isAltDisplay=false
     */
    var processSentence = function (sentEle, isAltDisplay, isClozeDeletion) {
      if (!getSetting(["sentence", "enabled"], true)) {
        return;
      }

      if (typeof isAltDisplay === "undefined") {
        logger.warn("isAltDisplay is undefined");
        isAltDisplay = false;
      }

      // removes linebreaks
      var result = sentEle.children[1].innerHTML;

      // cloze deletion replacing bold with [...]
      if (typeof isClozeDeletion !== "undefined" && isClozeDeletion) {
        result = result.replace(/<b>.*?<\/b>/g, "<b>[...]</b>");
      }

      if (
        (!isAltDisplay &&
          getSetting(["sentence", "remove-line-breaks"], true)) ||
        (isAltDisplay &&
          getSetting(["sentence", "remove-line-breaks-on-altdisplay"], false))
      ) {
        let noNewlines = result.replace(/<br>/g, "");

        // automatically removes newlines and other html elements
        // https://stackoverflow.com/a/54369605
        let charCount = [...sentEle.innerText.trim()].length;
        let maxCharCount = getSetting(
          ["sentence", "remove-line-breaks-until-char-count"],
          30
        );

        if (maxCharCount === 0 || charCount <= maxCharCount) {
          result = noNewlines;
        }
      }

      // removes leading and trailing white space (equiv. of strip() in python)
      result = result.trim();

      // selects the smallest containing sentence

      //if (!isAltDisplay && settings.sentence("select-smallest-sentence")) {
      //  result = selectSentence(result);
      //}

      //if (settings.quote("enabled", true)) {
      //  result = processQuote(sentEle, result, isAltDisplay);
      //} else {
      //  sentEle.innerHTML = result;
      //}

      //var processQuote = function(sentEle, sent, isAltDisplay) {
      //let result = sent;

      //let openQuote = null;
      //let closeQuote = null;
      //let validQuotes = settings.quote("quote-match-strings", [["「", "」"]])

      // if existing quotes:
      //     remove from sentence
      //     add to quote spans
      // if no existing quotes and if autoquote:
      //     add autoquote open / close to quote spans (if different)
      // if color quotes:
      //     add color quote class to outer divs

      let validQuotes = getSetting(
        ["sentence", "quote-match-strings"],
        [
          ["「", "」"],
          ["『", "』"],
        ]
      );
      let existingQuote = false;

      let openQuoteEle = sentEle.children[0];
      let closeQuoteEle = sentEle.children[2];

      for (let quotePair of validQuotes) {
        if (
          result[0] === quotePair[0] &&
          result[result.length - 1] === quotePair[1]
        ) {
          // adds quote to surrounding divs
          let openQuote = null;
          let closeQuote = null;
          [openQuote, closeQuote] = quotePair;
          openQuoteEle.innerText = openQuote;
          closeQuoteEle.innerText = closeQuote;

          result = result.slice(1, -1);
          existingQuote = true;
          break;
        }
      }

      let autoQuote =
        (!isAltDisplay &&
          getSetting(["sentence", "auto-quote-sentence"], true)) ||
        (isAltDisplay &&
          getSetting(["sentence", "auto-quote-alt-display-sentence"], false));
      if (!existingQuote && autoQuote) {
        openQuoteEle.innerText = getSetting(
          ["sentence", "auto-quote-open"],
          "「"
        );
        closeQuoteEle.innerText = getSetting(
          ["sentence", "auto-quote-close"],
          "」"
        );
      }

      // no quotes are added
      if (!existingQuote && !autoQuote) {
        // defaults to having quotes, in case javascript fails to load for some reason
        openQuoteEle.innerText = "";
        closeQuoteEle.innerText = "";

        sentEle.style["text-indent"] = "0em";
        sentEle.style["padding-left"] = "0em";
      }

      ///

      sentEle.children[1].innerHTML = result;
    };

    /*
     * Toggles the display of any given details tag
     */
    var toggleDetailsTag = function (ele) {
      if (ele.hasAttribute("open")) {
        ele.removeAttribute("open");
      } else {
        ele.setAttribute("open", "true");
      }
    };

    function processSentences(isAltDisplay, isClozeDeletion) {
      var sentences = document.querySelectorAll(".expression--sentence");

      if (sentences !== null) {
        for (let sent of sentences) {
          processSentence(sent, isAltDisplay, isClozeDeletion);
        }
      }
    }

    ///  /// note.card_type != "pa_word"

    ///

    ///

    ///
    ///

    // shift to switch between sentence & word on click & hover cards
    // NOTICE: we MUST use document.onkeyup instead of document.addEventListener(...)
    // because functions persist and cannot be easily removed within anki,
    // whereas .onkeyup = ... replaces the previous function with the current.
    document.onkeyup = (e) => {
      var keys = null;

      // tests for the existance of extraKeybindSettings
      //if (typeof extraKeybindSettings !== 'undefined') {
      //  extraKeybindSettings(e);
      //}

      ///

      ///

      ///
      ///

      /// {{#WordAudio}}
      //keys = settings.keybind("play-word-audio");
      keys = getSetting(["keybinds", "play-word-audio"], ["w"]);

      if (keys !== null && keys.includes(e.key)) {
        var elem = document.querySelector(
          "#word-audio .soundLink, #word-audio .replaybutton"
        );
        if (elem) {
          elem.click();
        }
      }
      /// {{/WordAudio}}

      /// {{#SentenceAudio}}
      keys = getSetting(["keybinds", "play-sentence-audio"], ["p"]);
      if (keys !== null && keys.includes(e.key)) {
        var hSent = document.getElementById("hybrid-sentence");

        ///
        var elem = document.querySelector(
          "#sentence-audio .soundLink, #sentence-audio .replaybutton"
        );
        if (elem) {
          elem.click();
        }
        ///
      }
      /// {{/SentenceAudio}}

      keys = getSetting(
        ["keybinds", "toggle-front-full-sentence-display"],
        ["'"]
      );
      var ele = document.getElementById("full_sentence_front_details");
      if (keys !== null && ele && keys.includes(e.key)) {
        toggleDetailsTag(ele);
      }

      /// {{#Hint}}
      keys = getSetting(["keybinds", "toggle-hint-display"], ["."]);
      var ele = document.getElementById("hint_details");
      if (keys !== null && ele && keys.includes(e.key)) {
        toggleDetailsTag(ele);
      }
      /// {{/Hint}}

      ///
    };

    //var OPTIONS_FILE = "jp-mining-note-options.js"; // const screws up anki for some reason lol
    //var injectScript = (src) => {
    //  return new Promise((resolve, reject) => {
    //    const script = document.createElement('script');
    //    script.src = src;
    //    script.async = true;
    //    script.onload = resolve;
    //    script.onerror = function(errorEvent) {
    //      // seems only to error if the options file is not found
    //      // syntax errors trigger the sanity check section and javascript error section
    //      logger.error("Options file not found! Make sure `" + OPTIONS_FILE + "` is placed in the media folder.");
    //    }
    //    document.head.appendChild(script);
    //  });
    //};

    //(async () => {

    //if (typeof JPMNOpts === 'undefined') {
    //  await injectScript(OPTIONS_FILE);
    //}

    //let JPMNOpts = createOptions();

    // sanity check
    if (typeof JPMNOpts === "undefined") {
      logger.error(
        "JPMNOpts was not defined in the options file. Was there an error?"
      );
    }

    // removes extra info section if not necessary
    var ele = document.querySelector(".pa-graphs");
    if (
      ele !== null &&
      ele.innerText.trim() === "No pitch accent data" &&
      !"{{#UtilityDictionaries}}a{{/UtilityDictionaries}}"
    ) {
      document.getElementById("extra_info_details").style.display = "none";
    }

    ///

    ///

    //var sentences = document.querySelectorAll(".expression--sentence")
    //var isAltDisplay = false;
    //var isClozeDeletion = false;

    //isAltDisplay = !!'{{#AltDisplay}}a{{/AltDisplay}}';

    var isAltDisplay = false;
    /* {{#AltDisplayPASentenceCard}} */
    isAltDisplay = true;
    /* {{/AltDisplayPASentenceCard}} */

    /* {{^AltDisplayPASentenceCard}} */
    /* {{#AltDisplay}} */
    isAltDisplay =
      /* {{^IsClickCard}}{{^IsHoverCard}}{{^IsSentenceCard}}{{^IsTargetedSentenceCard}} */
      false &&
      /* {{/IsTargetedSentenceCard}}{{/IsSentenceCard}}{{/IsHoverCard}}{{/IsClickCard}} */
      true
        ? true
        : false;
    /* {{/AltDisplay}} */

    /* {{^AltDisplay}} */
    isAltDisplay = false;
    /* {{/AltDisplay}} */
    /* {{/AltDisplayPASentenceCard}} */

    processSentences(isAltDisplay);

    ///
    ///

    //})();
  })();
</script>

{{/SentenceAudio}} {{/PASeparateSentenceCard}}
