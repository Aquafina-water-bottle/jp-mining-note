{{#FrequenciesStylized}}
  {{FrequenciesStylized}}
{{/FrequenciesStylized}}

<!-- it is expected that this file exists!
TODO visible error if it doesn't exist
the following should work (null check):

  if (typeof JPMNOpts === 'undefined') { ... }
-->
<script src="jp-mining-note-options.js"></script>


<script>
  // helper function
  var _getSetting = function(settingStr, settingObj) {
    if (!(settingStr in settingObj)) {
      return null;
    }
    return settingObj[settingStr];
  }

  var kbSetting = function(settingStr) {
    return _getSetting(settingStr, JPMNOpts.keybindSettings);
  }

  var getSetting = function(settingStr) {
    return _getSetting(settingStr, JPMNOpts.settings);
  }

  var selectSentence = function(temp) {
    // only chooses the sentence around the bold characters
    var firstMatch = temp.indexOf("<b>");
    var lastMatch = temp.lastIndexOf("</b>");

    // list of valid terminators
    // "removeEnd": is removed if found at the end of a sentence
    var terminators = {
      ".": {removeEnd: true},
      "。": {removeEnd: true},
      "．": {removeEnd: true},
      "︒": {removeEnd: true},

      "!": {removeEnd: false},
      "?": {removeEnd: false},
      "！": {removeEnd: false},
      "？": {removeEnd: false},
      "…": {removeEnd: false},
      "︕": {removeEnd: false},
      "︖": {removeEnd: false},
      "︙": {removeEnd: false},
    }


    if (firstMatch !== -1 && lastMatch !== -1) {
      var beginIdx = firstMatch;
      var endIdx = lastMatch;

      for (; beginIdx >= 0; beginIdx--) {
        if (temp[beginIdx] in terminators) {
          var obj = terminators[temp[beginIdx]];
          beginIdx++;

          //console.log(beginIdx);
          //console.log(temp[beginIdx]);
          break;
        }
      }

      for (; endIdx < temp.length; endIdx++) {
        if (temp[endIdx] in terminators) {
          var obj = terminators[temp[endIdx]];
          if (obj.removeEnd) {
              endIdx--;
          }

          //console.log(endIdx);
          //console.log(temp[endIdx]);
          //console.log(obj.removeEnd);
          break;
        }
      }

      // clamp
      if (beginIdx < 0) {
        beginIdx = 0;
      }
      if (endIdx > temp.length-1) {
        endIdx = temp.length-1;
      }

      temp = temp.substring(beginIdx, endIdx+1)

      // re-adds quotes if necessary
      if (temp[0] !== "「") {
        temp = "「" + temp;
      }
      if (temp[temp.length-1] !== "」") {
        temp = temp + "」";
      }
    }

    return temp;
  }


  /*
   * processes the sentence (if there is no altdisplay)
   * - removes newlines
   * - finds the shortest possible sentence around the bolded characters
   *   (if specified in the config)
   */
  var processSentence = function(sent) {

    // removes linebreaks
    var temp = sent.innerHTML.replace(/<br>/g, "");

    // removes leading and trailing white space (equiv. of strip() in python)
    temp = temp.trim();

    // selects the smallest containing sentence

    if (getSetting("select-smallest-sentence")) {
      temp = selectSentence(temp);
    }

    sent.innerHTML = temp;
  }

  /*
   * Toggles the display of any given details tag
   */
  var toggleDetailsTag = function(ele) {
    if (ele.hasAttribute('open')) {
      ele.removeAttribute('open');
    } else {
      ele.setAttribute("open", "true");
    }
  }


</script>

<div class="card-description">
  PA Sentence
  <div class="card-description-ver">JP Mining Note: Version 0.2.1.1</div>
</div>

<!-- note that for the PA separate sentence card, the front is ALWAYS a sentence -->
<!-- priority: AltDisplayPASentenceCard -> AltDisplay -> Sentence -->

<!-- option 1: AltDisplayPASentenceCard -->
{{#AltDisplayPASentenceCard}}
  <div class="expression expression--single" id="Display">{{furigana:AltDisplayPASentenceCard}}</div>
{{/AltDisplayPASentenceCard}}


{{^AltDisplayPASentenceCard}}
  {{#AltDisplay}}

    <div class="outer-display1
        {{^IsClickCard}} {{^IsHoverCard}} {{^IsSentenceCard}} {{^IsTargetedSentenceCard}}
          outer-display2
        {{/IsTargetedSentenceCard}} {{/IsSentenceCard}} {{/IsHoverCard}} {{/IsClickCard}}"
      id="Display">

      <!-- option 2: AltDisplay (only if the original card is a (sentence card or TSC or click or hybrid)) -->
      <!-- if any of (click, hover, sentence, TSC) -->
      <div class="expression expression--single inner-display1">
        {{furigana:AltDisplay}}
      </div>

      <!-- if none of (click, hover, sentence, TSC) -->
      <div class="expression expression--single inner-display2">
        「{{Sentence}}」
      </div>
    </div>

  {{/AltDisplay}}

  {{^AltDisplay}}
    <div class="expression expression--single" id="Display">「{{Sentence}}」</div>
  {{/AltDisplay}}


{{/AltDisplayPASentenceCard}}

{{^AltDisplay}}
  <script>
    // TODO change this into a query for sentences,
    // since Display is now a wrapper around inner-display 1/2
    sent = document.getElementById("Display");
    if (sent !== null) {
      processSentence(sent);
    }
  </script>
{{/AltDisplay}}

{{#HintNotHidden}}
  <div class="center-box-1 hint">
    <div class="center-box-2">
      <div class="bold-yellow">{{HintNotHidden}}</div>
    </div>
  </div>
{{/HintNotHidden}}

<!-- https://stackoverflow.com/questions/1269589/css-center-block-but-align-contents-to-the-left -->
<!-- tl;dr wrap anything you want centered + left justified with center-box-1 and center-box-2 -->
{{#Hint}}
  <details class="hint" id="hint_details">
    <summary>Hint</summary>
    <div class="center-box-1">
      <div class="center-box-2">
        <div class="bold-yellow">{{Hint}}</div>
      </div>
    </div>
  </details>
{{/Hint}}



<center>
  <div class="answer-border"></div>
</center>




<div class="def-header" id="def_header">

  <!-- everything on the left side -->
  <div class="dh-left dh-left--blue-border" id="dh_left">

    <div class="dh-left__reading"> {{furigana:WordReading}} </div>

    <div class="dh-left__word-pitch dh-left__word-pitch--big" id="dh_word_pitch">
       {{WordPitch}}
    </div>

    <script>
      var wp = document.getElementById("dh_word_pitch");

      // a bit of a hack...
      // The only reason why the downstep arrow exists in the first place is to make the downstep
      // mark visible while editing the field in anki. Otherwise, there is no reason for it to exist.
      wp.innerHTML = wp.innerHTML.replace(/&#42780/g, "").replace(/ꜜ/g, "");

      // entirely removes the (N/A) text instead
      var graphElement = document.getElementById("dh_left_graph");
      if (graphElement.innerText == "No pitch accent data" || graphElement.innerHTML == "") {
        document.getElementById("dh_left_graph").remove();
        document.getElementById("dh_left_gap").remove();

        // if there is no word pitch either, overrides it with N/A
        {{^WordPitch}}
          wp.innerText = "(N/A)";
        {{/WordPitch}}
      }
    </script>

    <div class="dh-left__bottom">
      <div class="dh-left__graph" id="dh_left_graph">
        {{Graph}}
      </div>
      <div class="dh-left__gap" id="dh_left_gap">
        ・
      </div>
      <div class="dh-left__audio-buttons">
        <span id="word-audio"> {{WordAudio}} </span>
        <span id="sentence-audio"> {{SentenceAudio}} </span>
      </div>
    </div>

  </div>

  <!-- everything on the right side -->
  {{#Picture}}
  <div class="dh-right" id="dh_right">
    <div class="dh-right__img-container" id="dh_img_container">{{Picture}}</div>
  </div>
  {{/Picture}}

</div>






<div id="back_side" class="back-side">

<div class="center-box-1">
  <div class="center-box-2">
    <div class="full-sentence bold-yellow" id="full_sentence">
        {{furigana:SentenceReading}}
    </div>
  </div>
</div>

<blockquote class="glossary-blockquote bold-yellow" id="primary_definition">
  {{furigana:PrimaryDefinition}}
</blockquote>

{{#SecondaryDefinition}}
  <details class="glossary-details" id="secondary_definition_details">
    <summary>Secondary Definition</summary>
    <blockquote class="glossary-blockquote bold-yellow">
    {{SecondaryDefinition}}
    </blockquote>
  </details>
{{/SecondaryDefinition}}

{{#AdditionalNotes}}
  <details class="glossary-details glossary-details--small" id="additional_notes_details">
    <summary>Additional Notes</summary>
    <blockquote class="glossary-blockquote glossary-blockquote--small bold-yellow">
    {{AdditionalNotes}}
    </blockquote>
  </details>
{{/AdditionalNotes}}


{{#ExtraDefinitions}}
  <details class="glossary-details glossary-details--small" id="extra_definitions_details">
    <summary>Extra Definitions</summary>
    <blockquote class="glossary-blockquote glossary-blockquote--small bold-yellow">
    {{ExtraDefinitions}}
    </blockquote>
  </details>
{{/ExtraDefinitions}}


</div> <!-- backside -->



<!--
  https://codeconvey.com/html-image-zoom-on-click/
  http://www.liangshunet.com/en/202005/743233073.htm
  https://stackoverflow.com/questions/8449933/how-to-transition-css-display-opacity-properties
  https://www.javascripttutorial.net/dom/css/add-styles-to-an-element/
  https://stackoverflow.com/questions/507138/how-to-add-a-class-to-a-given-element
-->
<!-- The Modal -->
<div id="modal" class="modal">
  <img class="modal-img" id="bigimg">
</div>

<script>
  var modal = document.getElementById('modal');
  var modalImg = document.getElementById("bigimg");

  // restricting the max height of image to the definition box
  var dhLeft = document.getElementById("dh_left");
  var dhRight = document.getElementById("dh_right");
  var heightLeft = dhLeft.offsetHeight;

  if (dhRight) {
    dhRight.style.maxHeight = heightLeft + "px";

    // setting up the modal styles and clicking
    var dhImgContainer = document.getElementById("dh_img_container");
    var imgList = dhImgContainer.getElementsByTagName("img");

    if (imgList && imgList.length === 1) {
      var img = dhImgContainer.getElementsByTagName("img")[0];
      img.classList.add("dh-right__img");
      img.style.maxHeight = heightLeft + "px"; // restricts max height here too

      img.onclick = function() {
        modal.style.display = "block";
        modalImg.src = this.src;
      }

    } else { // otherwise we hope that there are 0 images here
      // support for no images here: remove the fade-in / fade-out on text
      // the slightly hacky method is just to remove the class all together lol
      dhImgContainer.className = "";
    }
  }


  // close the modal upon click
  modal.onclick = function() {
    bigimg.classList.add("modal-img__zoom-out");
    modal.classList.add("modal-img__zoom-out");
    setTimeout(function() {
      modal.style.display = "none";
      bigimg.className = "modal-img";
      modal.className = "modal";
    }, 200);
  }

  // creates a custom image container to hold yomichan images
  function createImgContainer(imgName) {
    // creating this programmically:
    // <span class="glossary__image-container">
    //   <a class="glossary__image-hover-text" href='javascript:;'>[Image]</a>
    //   <img class="glossary__image-hover-media" src="${imgName}">
    // </span>

    var defSpan = document.createElement('span');
    defSpan.classList.add("glossary__image-container");

    var defAnc = document.createElement('a');
    defAnc.classList.add("glossary__image-hover-text");
    defAnc.href = "javascript:;'>[Image]";
    defAnc.textContent = "[Image]";

    var defImg = document.createElement('img');
    defImg.classList.add("glossary__image-hover-media");
    defImg.src = imgName;

    defImg.onclick = function() {
      modal.style.display = "block";
      modalImg.src = this.src;
    }

    defAnc.onclick = function() {
      modal.style.display = "block";
      modalImg.src = defImg.src;
    }

    defSpan.appendChild(defAnc);
    defSpan.appendChild(defImg);

    return defSpan;
  }

  // remove all jmdict english dict tags
  var glossaryEle = document.getElementById("primary_definition");
  glossaryEle.innerHTML = glossaryEle.innerHTML.replace(/, JMdict \(English\)/g, "");

  // goes through each blockquote and searches for yomichan inserted images
  var imageSearchElements = document.getElementsByTagName("blockquote");
  for (var searchEle of imageSearchElements) {
    anchorTags = searchEle.getElementsByTagName("a");
    for (var atag of anchorTags) {
      var imgFileName = atag.getAttribute("href");
      if (imgFileName && imgFileName.substring(0, 25) === "yomichan_dictionary_media") {
        var fragment = createImgContainer(imgFileName);
        atag.parentNode.replaceChild(fragment, atag);
      }
    }
  }
</script>

<script>
  // THIS IS A HACK to play sentence audio first and to not autoplay the word audio
  var elem = document.querySelector("#sentence-audio .soundLink, #sentence-audio .replaybutton");
  if (elem) {
    elem.click();
  }
</script>


<script>
  // shift to switch between sentence & word on click & hover cards
  // NOTICE: we MUST use document.onkeyup instead of document.addEventListener(...)
  // because functions persist and cannot be easily removed within anki,
  // whereas .onkeyup = ... replaces the previous function with the current.
  document.onkeyup = (e => {
    var keys = null;

    // tests for the existance of extraKeybindSettings
    if (typeof extraKeybindSettings !== 'undefined') {
      extraKeybindSettings(e);
    }

    {{#WordAudio}}
      keys = kbSetting("play-word-audio");
      if (keys !== null && keys.includes(e.key)) {
        var elem = document.querySelector("#word-audio .soundLink, #word-audio .replaybutton");
        if (elem) {
          elem.click();
        }
      }
    {{/WordAudio}}

    {{#SentenceAudio}}
      keys = kbSetting("play-sentence-audio");
      if (keys !== null && keys.includes(e.key)) {
        var elem = document.querySelector("#sentence-audio .soundLink, #sentence-audio .replaybutton");
        if (elem) {
          elem.click();
        }
      }
    {{/SentenceAudio}}

    keys = kbSetting("toggle-front-full-sentence-display");
    var ele = document.getElementById("full_sentence_front_details");
    if (keys !== null && ele && keys.includes(e.key)) {
      toggleDetailsTag(ele)
    }

    {{#Hint}}
      keys = kbSetting("toggle-hint-display");
      var ele = document.getElementById("hint_details");
      if (keys !== null && ele && keys.includes(e.key)) {
        toggleDetailsTag(ele)
      }
    {{/Hint}}

    {{#SecondaryDefinition}}
      keys = kbSetting("toggle-secondary-definitions-display");
      var ele = document.getElementById("secondary_definition_details");
      if (keys !== null && ele && keys.includes(e.key)) {
        toggleDetailsTag(ele)
      }
    {{/SecondaryDefinition}}

    {{#AdditionalNotes}}
      keys = kbSetting("toggle-additional-notes-display");
      var ele = document.getElementById("additional_notes_details");
      if (keys !== null && ele && keys.includes(e.key)) {
        toggleDetailsTag(ele)
      }
    {{/AdditionalNotes}}

    {{#ExtraDefinitions}}
      keys = kbSetting("toggle-extra-definitions-display");
      var ele = document.getElementById("extra_definitions_details");
      if (keys !== null && ele && keys.includes(e.key)) {
        toggleDetailsTag(ele)
      }
    {{/ExtraDefinitions}}
  })
</script>
