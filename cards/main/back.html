<div class="card-description">
  Mining Card:

  {{#IsSentenceCard}}
      Sentence
  {{/IsSentenceCard}}

  {{^IsSentenceCard}}
      Word
  {{/IsSentenceCard}}

  /

  {{#IsClozeDeletionCard}}
    Listening
  {{/IsClozeDeletionCard}}

  <!-- not listening card -->
  {{^IsClozeDeletionCard}}
    {{#PADoNotShowInfoLegacy}}
      Legacy
    {{/PADoNotShowInfoLegacy}}

    <!-- not legacy card -->
    {{^PADoNotShowInfoLegacy}}

      <!--
      anki doesn't allow "or" logic in templates,
      so I replicate it by repeating things a bunch of times...

          A v B  = (A ^ ~B) v (~A ^ B) v (A ^ B)
          ~(A v B) =  ~A ^ ~B
      For more readable logic, check the "Word pitch indicator color" javascript code
      -->

      <!-- PADoNotTest or PASeparateWordCard == none -->
      {{#PADoNotTest}} {{#PASeparateWordCard}}
        None
      {{/PASeparateWordCard}} {{/PADoNotTest}}
      {{^PADoNotTest}} {{#PASeparateWordCard}}
        None
      {{/PASeparateWordCard}} {{/PADoNotTest}}
      {{#PADoNotTest}} {{^PASeparateWordCard}}
        None
      {{/PASeparateWordCard}} {{/PADoNotTest}}

      <!-- neither PADoNotTest, PASeparateWordCard are filled -->
      <!-- we then test the PA somewhere -->
      {{^PADoNotTest}} {{^PASeparateWordCard}}

        <!-- PASeparateSentenceCard or PATestOnlyWord == word -->
        {{#PASeparateSentenceCard}} {{^PATestOnlyWord}}
          Word
        {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}
        {{^PASeparateSentenceCard}} {{#PATestOnlyWord}}
          Word
        {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}
        {{#PASeparateSentenceCard}} {{#PATestOnlyWord}}
          Word
        {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}

        <!-- if none of the above, then we test the sentence (default value) -->
        {{^PASeparateSentenceCard}} {{^PATestOnlyWord}}
          Sentence
        {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}

      {{/PASeparateWordCard}} {{/PADoNotTest}}

    {{/PADoNotShowInfoLegacy}}

  {{/IsClozeDeletionCard}}
</div>


<!-- listening unknown card -->
{{#IsClozeDeletionCard}}
  <!-- defaults to alt display -->
  {{#AltDisplay}}
    <div class="expression expression--single bold-yellow" id="Display">{{furigana:AltDisplay}}</div>
  {{/AltDisplay}}

  {{^AltDisplay}}
    <div class="expression expression--single bold-yellow" id="Display">「{{Sentence}}」</div>
  {{/AltDisplay}}

  <script>
    var d = document.getElementById("Display");
    d.innerHTML = d.innerHTML.replace(/<b>.*<\/b>/g, "<b>[...]</b>");
  </script>

{{/IsClozeDeletionCard}}




<!-- not listening card -->
{{^IsClozeDeletionCard}}


<!-- legacy display -->
{{#PADoNotShowInfoLegacy}}

  <!-- priority is on the alternate display sentence -->
  {{#AltDisplay}}
    {{#IsSentenceCard}}
      <div class="expression expression--single" id="Display">{{furigana:AltDisplay}}</div>
    {{/IsSentenceCard}}

    {{^IsSentenceCard}}
      <div class="expression expression--single expression--word" id="Display">{{furigana:AltDisplay}}</div>
    {{/IsSentenceCard}}
  {{/AltDisplay}}


  <!-- no alt display sentence, not listening card -->
  {{^AltDisplay}}
    {{#IsSentenceCard}}
      <div class="expression expression--single" id="Display">「{{Sentence}}」</div>
    {{/IsSentenceCard}}

    {{^IsSentenceCard}}
      <div class="expression expression--single expression--word" id="Display">{{Word}}</div>
    {{/IsSentenceCard}}
  {{/AltDisplay}}

{{/PADoNotShowInfoLegacy}}


<!-- regular display -->
{{^PADoNotShowInfoLegacy}}
  <div class="expression-box">

    <div class="flag-box">
      <svg xmlns="http://www.w3.org/2000/svg" focusable="false" viewBox="0 0 50 50"
        style="display:inline-block;vertical-align:middle;height:1.5em;">
        <circle id="svg_circle" class="flag-box__circle" cx="25" cy="15" r="7">
          <title id=svg_title></title>
        </circle>
      </svg>
    </div>

    {{#IsSentenceCard}}
      <!--
        different circle positions depending on whether it's a sentence or not.
        More specifically, checks if the first character is "「",
        and adjusts the position based on that
      -->
      <script>
        var circ = document.getElementById("svg_circle");
        var d = document.getElementById("Display");
        if (d.innerText.length > 0 && d.innerText[0] == "「") {
          circ.setAttributeNS(null, "cx", "35");
          circ.setAttributeNS(null, "cy", "11");
        }
      </script>
    {{/IsSentenceCard}}

    <script>
      // ============================
      //  Word pitch indicator color
      // ============================
      var svgTitle = document.getElementById("svg_title");
      var styleClass = "";

      if ("{{PADoNotTest}}{{PASeparateWordCard}}") {
        // PADoNotTest or PASeparateWordCard
        styleClass = "flag-box__circle--none";
        svgTitle.textContent = "PA: Do not test";
      } else {
        if ("{{PASeparateSentenceCard}}{{PATestOnlyWord}}") {
          // either PASeparateSentenceCard or PATestOnlyWord
          styleClass = "flag-box__circle--word";
          svgTitle.textContent = "PA: Word";
        } else {
          styleClass = "flag-box__circle--all";
          svgTitle.textContent = "PA: Sentence";
        }

        // ~(isSentenceCard) overrides color (should 'test all')
        if (!"{{IsSentenceCard}}") {
          styleClass = "flag-box__circle--all"
        }
      }

      var circ = document.getElementById("svg_circle");
      circ.classList.add(styleClass);
    </script>



    <!-- priority is on the alternate display sentence -->
    {{#AltDisplay}}
      {{#IsSentenceCard}}
        <div class="expression" id="Display">{{furigana:AltDisplay}}</div>
      {{/IsSentenceCard}}

      {{^IsSentenceCard}}
        <div class="expression expression--word" id="Display">{{furigana:AltDisplay}}</div>
      {{/IsSentenceCard}}
    {{/AltDisplay}}


    <!-- no alt display sentence, not listening card -->
    {{^AltDisplay}}
      {{#IsSentenceCard}}
        <div class="expression" id="Display">「{{Sentence}}」</div>
      {{/IsSentenceCard}}

      {{^IsSentenceCard}}
        <div class="expression expression--word" id="Display">{{Word}}</div>
      {{/IsSentenceCard}}
    {{/AltDisplay}}

  </div>

{{/PADoNotShowInfoLegacy}}

{{/IsClozeDeletionCard}}
<!-- not listening card -->


{{#Hint}}
  <div class="center-box-1">
    <div class="center-box-2">
      <div class="hint bold-yellow">{{hint:Hint}}</div>
    </div>
  </div>
{{/Hint}}




<!-- regular display -->
{{^PADoNotShowInfoLegacy}}

<!-- for pitch accent to be properly tested:
  - Must not be already a listening card here
  - PADoNotTest must be empty
  - WordPitch be non-empty
-->

{{^IsClozeDeletionCard}}

{{^PADoNotTest}}


  <script>
    // ======================
    //  Word pitch indicator
    // ======================

    var svgTitle = document.getElementById("svg_title");

    var styleClass = "";
    if ("{{PASeparateSentenceCard}}{{PATestOnlyWord}}") { // either PASeparateSentenceCard or PATestOnlyWord
      styleClass = "flag-box__circle--word";
      svgTitle.textContent = "PA: Word";
    } else {
      styleClass = "flag-box__circle--all";
      svgTitle.textContent = "PA: Sentence";
    }

    // ~(isSentenceCard) overrides style (should be test PA star)
    if (!"{{IsSentenceCard}}") {
      styleClass = "flag-box__circle--all"
    }

    var circ = document.getElementById("svg_circle");
    circ.classList.add(styleClass);
  </script>

{{/PADoNotTest}}


<!-- explicitly do not test pitch accent -->
{{#PADoNotTest}}

  <script>
    var circ = document.getElementById("svg_circle");
    circ.classList.add("flag-box__circle--none");

    // https://stackoverflow.com/a/13546213
    var svgTitle = document.getElementById("svg_title");
    svgTitle.textContent = "PA: Do not test";
  </script>

{{/PADoNotTest}}


{{/IsClozeDeletionCard}}

{{/PADoNotShowInfoLegacy}}



<hr id=answer width="95%">





<div class="def-header" id="def_header">

  <!-- everything on the left side -->
  <div class="dh-left" id="dh_left">

    <div class="dh-left__reading"> {{furigana:WordReading}} </div>
    <div class="dh-left__word-pitch" id="dh_word_pitch">
      {{#WordPitch}}
        {{WordPitch}}
      {{/WordPitch}}
      {{^WordPitch}}
        N/A
      {{/WordPitch}}
    </div>
    <script>
      // a bit of a hack...
      // The only reason why the downstep arrow exists in the first place is to make the downstep
      // mark visible while editing the field in anki. Otherwise, there is no reason for it to exist.
      var wp = document.getElementById("dh_word_pitch");
      wp.innerHTML = wp.innerHTML.replace(/&#42780/g, "").replace(/ꜜ/g, "");
    </script>

     <div class="dh-left__audio-buttons">
        {{WordAudio}} {{SentenceAudio}}
    </div>
  </div>

  <div class="dh-gap" id="dh_gap"> </div>

  <!-- everything on the right side -->
  <div class="dh-right" id="dh_right">
    <div class="dh-right__img-container" id="dh_img_container">{{Picture}}</div>
  </div>

</div>





<div id="back_side" class="back-side">

<!-- https://stackoverflow.com/questions/1269589/css-center-block-but-align-contents-to-the-left -->
<!-- tl;dr wrap anything you want centered + left justified with center-box-1 and center-box-2 -->
<div class="center-box-1">
  <div class="center-box-2">
    <div class="full-sentence bold-yellow" id="full_sentence">
        {{furigana:SentenceReading}}
    </div>
  </div>
</div>

<!-- https://stackoverflow.com/questions/14380442/make-one-section-of-simple-web-page-have-own-scroll-bar -->


<blockquote class="glossary-blockquote bold-yellow" id="primary_definition">
  {{edit:PrimaryDefinition}}
</blockquote>


{{#SecondaryDefinition}}
  <details class="glossary-details">
    <summary>Secondary Definition</summary>
    <blockquote class="glossary-blockquote bold-yellow">
    {{SecondaryDefinition}}
    </blockquote>
  </details>
{{/SecondaryDefinition}}

{{#AdditionalNotes}}
  <details class="glossary-details glossary-details--small">
    <summary>Additional Notes</summary>
    <blockquote class="glossary-blockquote glossary-blockquote--small bold-yellow">
    {{AdditionalNotes}}
    </blockquote>
  </details>
{{/AdditionalNotes}}


{{#ExtraDefinitions}}
  <details class="glossary-details glossary-details--small">
    <summary>Extra Definitions</summary>
    <blockquote class="glossary-blockquote glossary-blockquote--small bold-yellow">
    {{ExtraDefinitions}}
    </blockquote>
  </details>
{{/ExtraDefinitions}}


<!--
  https://codeconvey.com/html-image-zoom-on-click/
  http://www.liangshunet.com/en/202005/743233073.htm
  https://stackoverflow.com/questions/8449933/how-to-transition-css-display-opacity-properties
  https://www.javascripttutorial.net/dom/css/add-styles-to-an-element/
  https://stackoverflow.com/questions/507138/how-to-add-a-class-to-a-given-element
-->

<div id="modal" class="modal">
  <img class="modal-img" id="bigimg">
</div>

<script>

  // dynamically adjusts gap width
  // note: the image appears after a short period of the card loading
  // which makes the image "pop" into place (and doesn't look very good)
  // not really sure how to fix this though :(
  // https://stackoverflow.com/questions/4787527/how-to-find-the-width-of-a-div-using-vanilla-javascript
  function adjust_boxes(width_right, ele_right) {
    //var width_left = document.getElementById("dh_left").clientWidth;
    //if (saved_width_img === null) {
    //  saved_width_img = img.clientWidth;
    //}
    //var width_right = saved_width_img;
    //var width_right = img.clientWidth;
    //glossary_ele.innerText += "x:" + width_left + " y:" + width_right

    //var width = width_left + width_right;
    //// what https://attacomsian.com/blog/javascript-get-css-styles
    var computed_style = window.getComputedStyle(document.getElementById("back_side"));
    var max_width = parseInt(computed_style.maxWidth.replace("px", ""));
    var scaled_width = parseInt(computed_style.width.replace("px", ""));
    var current_width = Math.min(max_width, scaled_width);

    //glossary_ele.innerText += "A: " + window.getComputedStyle(document.getElementById("back_side")).width;
    var gap_width = 35; // TODO get dynamically from css
    //var gap_width = (max_width - width - 3) / 3.2;

    ////document.getElementById("left_gap").style.width  = gap_width + "px";
    //document.getElementById("dh_gap").style.width   = gap_width + "px";
    ////document.getElementById("right_gap").style.width = gap_width + "px";

    var add_padding = current_width - (width_left + width_right + gap_width);
    //glossary_ele.innerText += "nh:" + add_padding;
    if (add_padding < 0) { // left box is too big, shrink image

      var shrink_size = current_width - width_left - gap_width;
      ele_right.style.maxWidth = shrink_size + "px";
      //document.getElementById("dh_left").style.paddingLeft = "0px";
      //document.getElementById("dh_left").style.paddingRight = "0px";

    } else { // add extra padding to left box to make it bigger
      var add_padding_side = (add_padding / 2) - 1;
      document.getElementById("dh_left").style.paddingLeft = add_padding_side + "px";
      document.getElementById("dh_left").style.paddingRight = add_padding_side + "px";
    }
  }


  var modal = document.getElementById('modal');
  var modalImg = document.getElementById("bigimg");

  // restricting the max height of image to the definition box
  var lb = document.getElementById("dh_left");
  var rb = document.getElementById("dh_right");
  var smalldiv = document.getElementById("dh_img_container");
  var width_left =  lb.clientWidth;
  var height_left = lb.clientHeight;

  // Get the image and insert it inside the modal - use its "alt" text as a caption
  //var img = document.getElementById('myImg');
  var img_list = smalldiv.getElementsByTagName("img");
  if (img_list.length == 1) {
    var img = smalldiv.getElementsByTagName("img")[0];
    img.classList.add("dh-right__img");
    img.style.maxHeight = height_left + "px";

    img.onclick = function() {
      modal.style.display = "block";
      modalImg.src = this.src;
      modalImg.alt = this.alt;
    }

    img.onload = function() { // a bit of a hack to require the image to load first before getting the width
      adjust_boxes(img.clientWidth, img);
    }

  } else {
    // hopefully length is 0 here...
    // support for no images here: remove 
    // the hacky method is just to remove the class all together lol
    smalldiv.className = "";
    adjust_boxes(smalldiv.clientWidth, smalldiv)
  }

  // When the user clicks on <span> (x), close the modal
  modal.onclick = function() {
    //bigimg.className += " out";
    bigimg.classList.add("modal-img__zoom-out");
    modal.classList.add("modal-img__zoom-out");
    setTimeout(function() {
      modal.style.display = "none";
      bigimg.className = "modal-img";
      modal.className = "modal";
    }, 200);
  }

  function createImgContainer(imgName) {
    // creating this programmically:
    // <span class="glossary__image-container">
    //   <a class="glossary__image-hover-text" href='javascript:;'>[Image]</a>
    //   <img class="glossary__image-hover-media" src="${imgName}">
    // </span>

    var defSpan = document.createElement('span');
    defSpan.classList.add("glossary__image-container");

    var defAnc = document.createElement('a');
    defAnc.classList.add("glossary__image-hover-text");
    defAnc.href = "javascript:;'>[Image]";
    defAnc.textContent = "[Image]";

    var defImg = document.createElement('img');
    defImg.classList.add("glossary__image-hover-media");
    defImg.src = imgName;

    defImg.onclick = function() {
      modal.style.display = "block";
      modalImg.src = this.src;
    }

    defAnc.onclick = function() {
      modal.style.display = "block";
      modalImg.src = defImg.src;
    }

    defSpan.appendChild(defAnc);
    defSpan.appendChild(defImg);

    return defSpan;
  }

  // goes through each blockquote and searches for yomichan inserted images
  var imageSearchElements = document.getElementsByTagName("blockquote");
  for (var searchEle of imageSearchElements) {
    anchorTags = searchEle.getElementsByTagName("a");
    for (var atag of anchorTags) {
      var imgFileName = atag.getAttribute("href");
      //var imgFileName = atag.href;
      if (imgFileName && imgFileName.substring(0, 25) == "yomichan_dictionary_media") {
        //document.getElementById("primary_definition").innerHTML += `detected '${imgFileName}'`;
        var fragment = createImgContainer(imgFileName);
        atag.parentNode.replaceChild(fragment, atag);
      }
    }
  }


  // remove all jmdict english dict tags lol
  var glossary_ele = document.getElementById("primary_definition");
  glossary_ele.innerHTML = glossary_ele.innerHTML.replace(/, JMdict \(English\)/g, "");

  //glossary_ele.innerText += "h:" + height_left;
  //glossary_ele.innerText += "nh:" + img.naturalHeight;


  //var resizeTimeout;
  //window.addEventListener('resize', function(event) {
  //  clearTimeout(resizeTimeout);
  //  resizeTimeout = setTimeout(function(){
  //    // DOES THIS WORK LOL
  //    img.onload();
  //    //window.location.reload();
  //  }, 1500);
  //});


</script>

</div> <!-- backside -->

