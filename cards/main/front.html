<!--
  Listening
  X / Y

  X:
    Word
    Sentence

  Y:
    Legacy
    None
    Word
    Sentence

-->
<div class="cardDesc">
  Mining Card:

  {{#IsSentenceCard}}
      Sentence
  {{/IsSentenceCard}}

  {{^IsSentenceCard}}
      Word
  {{/IsSentenceCard}}

  /

  {{#IsClozeDeletionCard}}
    Listening
  {{/IsClozeDeletionCard}}

  <!-- not listening card -->
  {{^IsClozeDeletionCard}}
    {{#PADoNotShowInfoLegacy}}
      Legacy
    {{/PADoNotShowInfoLegacy}}

    <!-- not legacy card -->
    {{^PADoNotShowInfoLegacy}}

      {{#PADoNotTest}}
        None
      {{/PADoNotTest}}

      <!-- not (explicity do not test PA) -->
      {{^PADoNotTest}}

        <!--
          ffs anki
          - realistically, it shouldn't ever be (A ^ B) but whatever
          - separate sentence card & ~test only word is normal
          - ~separate sentence card & test only word is also normal (force a test word instead)
          A v B  = (A ^ ~B) v (~A ^ B) v (A ^ B)
          ~(A v B) =  ~A ^ ~B
        -->
        {{#PASeparateSentenceCard}} {{^PATestOnlyWord}}
          Word
        {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}
        {{^PASeparateSentenceCard}} {{#PATestOnlyWord}}
          Word
        {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}
        {{#PASeparateSentenceCard}} {{#PATestOnlyWord}}
          Word
        {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}

        {{^PASeparateSentenceCard}} {{^PATestOnlyWord}}
          Sentence
        {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}

      {{/PADoNotTest}}

    {{/PADoNotShowInfoLegacy}}

  {{/IsClozeDeletionCard}}
</div>


<!-- listening unknown card -->
{{#IsClozeDeletionCard}}
    <!-- defaults to sentence card -->
    {{#AltDisplay}}
        <div class="expression" id="Display">{{furigana:AltDisplay}}</div>
    {{/AltDisplay}}

    {{^AltDisplay}}
        <div class="expression" id="Display">{{Sentence}}</div>
    {{/AltDisplay}}

    <script>
        document.getElementById("Display").innerHTML = "「{{Sentence}}」".replace(/<b>.*<\/b>/g, "<b>[...]</b>");
    </script>

{{/IsClozeDeletionCard}}




<!-- not listening card -->
{{^IsClozeDeletionCard}}

<div class="expression-box">

  <!-- priority is on the alternate display sentence -->
  {{#AltDisplay}}
    {{#IsSentenceCard}}
      <div class="flag-box">
        <svg xmlns="http://www.w3.org/2000/svg" focusable="false" viewBox="0 0 50 50"
          style="display:inline-block;vertical-align:middle;height:1.5em;">
          <circle id="flag-box__circle" cx="35" cy="11" r="7"></circle>
        </svg>
      </div>
      <div class="expression overridedisplay" id="Display">{{furigana:AltDisplay}}</div>
    {{/IsSentenceCard}}

    {{^IsSentenceCard}}
      <div class="flag-box">
        <svg xmlns="http://www.w3.org/2000/svg" focusable="false" viewBox="0 0 50 50"
          style="display:inline-block;vertical-align:middle;height:1.5em;">
          <circle id="flag-box__circle" cx="25" cy="15" r="7"></circle>
        </svg>
      </div>
      <div class="expression expression--word" id="Display">{{furigana:AltDisplay}}</div>
    {{/IsSentenceCard}}
  {{/AltDisplay}}


  <!-- no alt display sentence, not listening card -->
  {{^AltDisplay}}
    {{#IsSentenceCard}}
      <div class="flag-box">
        <svg xmlns="http://www.w3.org/2000/svg" focusable="false" viewBox="0 0 50 50"
          style="display:inline-block;vertical-align:middle;height:1.5em;">
          <circle id="flag-box__circle" cx="35" cy="11" r="7"></circle>
        </svg>
      </div>
      <div class="expression overridedisplay" id="Display">「{{Sentence}}」</div>
    {{/IsSentenceCard}}

    {{^IsSentenceCard}}
      <div class="flag-box">
        <svg xmlns="http://www.w3.org/2000/svg" focusable="false" viewBox="0 0 50 50"
          style="display:inline-block;vertical-align:middle;height:1.5em;">
          <circle id="flag-box__circle" cx="25" cy="15" r="7"></circle>
        </svg>
      </div>
      <div class="expression expression--word" id="Display">{{Word}}</div>
    {{/IsSentenceCard}}
  {{/AltDisplay}}

</div>


{{/IsClozeDeletionCard}}
<!-- not listening card -->



{{#Hint}}
  <div class="center-box-1">
    <div class="center-box-2">
      <div class="hint">{{hint:Hint}}</div>
    </div>
  </div>
{{/Hint}}


<!-- audio and [...] replace for the listening card -->
{{#IsClozeDeletionCard}}

    <script>
        document.getElementById("Display").innerHTML = "「{{Sentence}}」".replace(/<b>.*<\/b>/g, "<b>[...]</b>");
    </script>
    <span id="audio-front">{{SentenceAudio}}</span>

{{/IsClozeDeletionCard}}



<!-- do not separate pitch accent card -->
{{^PADoNotShowInfoLegacy}}

<!-- for pitch accent to be properly tested:
  - Must not be already a listening card here
  - PADoNotTest must be empty
-->

{{^IsClozeDeletionCard}}

{{^PADoNotTest}}



<!-- if the display is a sentence but we only want to test word pitch accent -->
{{#IsSentenceCard}}
  {{#PASeparateSentenceCard}} {{^PATestOnlyWord}}
    <button id="PAButton" oncontextmenu="event.preventDefault();" onclick="logMouseButton()">Show</button>
  {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}
  {{^PASeparateSentenceCard}} {{#PATestOnlyWord}}
    <button id="PAButton" oncontextmenu="event.preventDefault();" onclick="logMouseButton()">Show</button>
  {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}
  {{#PASeparateSentenceCard}} {{#PATestOnlyWord}}
    <button id="PAButton" oncontextmenu="event.preventDefault();" onclick="logMouseButton()">Show</button>
  {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}

  <!-- script here because too lazy to copy/paste -->
  <!-- https://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/button -->
  <script>
    var pa_button = document.getElementById("PAButton");
    var d = document.getElementById("Display");

    function logMouseButton() {
      if (pa_button.innerText == "Show") {
        pa_button.innerText = "Hide";
        d.classList = "expression";
      } else {
        pa_button.innerText = "Show";
        d.classList.add("overridedisplay");
      }
    }
  </script>

{{/IsSentenceCard}}


<!--
  if the display is a word: show sentence preview (spoilered)
  - note that it is guaranteed we test pitch accent here already
-->
{{^IsSentenceCard}}
  <details>
      <summary class=glossary>Full Sentence</summary>
      <div class="center-box-1">
        <div class="center-box-2">
          <div class=fullsentence id="fullsentencefront">「{{Sentence}}」</div>
        </div>
      </div>
  </details>
{{/IsSentenceCard}}



  <script>
    // =====================
    //  THIS PART IS A HACK
    // =====================
    // this hack is to not auto-play the audio at the front of the card
    // https://forums.ankiweb.net/t/disabling-audio-autoplay-for-certain-fields/6318/3
    // https://forums.ankiweb.net/t/controlling-display-and-function-of-audio-buttons/10234
    var elem = document.querySelector(".soundLink, .replaybutton");
    if (elem) {
      elem.click();
    }


    // ======================
    //  Word pitch indicator
    // ======================
    var style_class = "";
    if ("{{PASeparateSentenceCard}}{{PATestOnlyWord}}") { // either PASeparateSentenceCard or PATestOnlyWord
      style_class = "flag-box__circle--word";
    } else {
      style_class = "flag-box__circle--all";
    }

    // ~(isSentenceCard) overrides style (should be test PA star)
    if (!"{{IsSentenceCard}}") {
      style_class = "flag-box__circle--all"
    }

    var circ = document.getElementById("flag-box__circle");
    circ.classList.add(style_class);
  </script>
  <span id="audio-front-silence" style="display:none">{{PASilence}}</span>
  <span id="audio-front">
    {{#SentenceAudio}}
      {{SentenceAudio}}
    {{/SentenceAudio}}
    {{^SentenceAudio}}
      {{WordAudio}}
    {{/SentenceAudio}}
  </span>


{{/PADoNotTest}}


<!-- explicitly do not test pitch accent -->
{{#PADoNotTest}}

  <script>
    var circ = document.getElementById("flag-box__circle");
    circ.classList.add("flag-box__circle--none");
  </script>

{{/PADoNotTest}}


{{/IsClozeDeletionCard}}

{{/PADoNotShowInfoLegacy}}



