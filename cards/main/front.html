<!--
  Listening
  X / Y

  X:
    Word
    Sentence
    Hybrid

  Y:
    Legacy
    None
    Word
    Sentence
-->

<div class="card-description">
  Mining Card:

  {{#IsHoverCard}}
    Hover ({{#IsSentenceCard}}Sentence{{/IsSentenceCard}}{{^IsSentenceCard}}Word{{/IsSentenceCard}})
  {{/IsHoverCard}}

  {{^IsHoverCard}}

    {{#IsClickCard}}
      Click ({{#IsSentenceCard}}Sentence{{/IsSentenceCard}}{{^IsSentenceCard}}Word{{/IsSentenceCard}})
    {{/IsClickCard}}

    {{^IsClickCard}}
      {{#IsSentenceCard}}
        {{#ForceHighlightSentence}}
          TSC
        {{/ForceHighlightSentence}}
        {{^ForceHighlightSentence}}
          Sentence
        {{/ForceHighlightSentence}}
      {{/IsSentenceCard}}

      {{^IsSentenceCard}}
          Word
      {{/IsSentenceCard}}
    {{/IsClickCard}}
  {{/IsHoverCard}}

  /

  {{#PADoNotShowInfoLegacy}}
    Legacy
  {{/PADoNotShowInfoLegacy}}

  <!-- not legacy card -->
  {{^PADoNotShowInfoLegacy}}

    <!--
    anki doesn't allow "or" logic in templates,
    so I replicate it by repeating things a bunch of times...

        A v B  = (A ^ ~B) v (~A ^ B) v (A ^ B)
        ~(A v B) =  ~A ^ ~B
    For more readable logic, check the "Word pitch indicator color" javascript code
    -->

    <!-- PADoNotTest or PASeparateWordCard == none -->
    {{#PADoNotTest}} {{#PASeparateWordCard}}
      None
    {{/PASeparateWordCard}} {{/PADoNotTest}}
    {{^PADoNotTest}} {{#PASeparateWordCard}}
      None
    {{/PASeparateWordCard}} {{/PADoNotTest}}
    {{#PADoNotTest}} {{^PASeparateWordCard}}
      None
    {{/PASeparateWordCard}} {{/PADoNotTest}}

    <!-- neither PADoNotTest, PASeparateWordCard are filled -->
    <!-- we then test the PA somewhere -->
    {{^PADoNotTest}} {{^PASeparateWordCard}}

      <!-- PASeparateSentenceCard or PATestOnlyWord == word -->
      {{#PASeparateSentenceCard}} {{^PATestOnlyWord}}
        Word
      {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}
      {{^PASeparateSentenceCard}} {{#PATestOnlyWord}}
        Word
      {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}
      {{#PASeparateSentenceCard}} {{#PATestOnlyWord}}
        Word
      {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}

      <!-- if none of the above, then we test the default value -->
      {{^PASeparateSentenceCard}} {{^PATestOnlyWord}}

        <!-- note that hybrid cards only test the word -->
        {{#IsSentenceCard}}
            Sentence
        {{/IsSentenceCard}}

        {{^IsSentenceCard}}
            Word
        {{/IsSentenceCard}}

      {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}

    {{/PASeparateWordCard}} {{/PADoNotTest}}

  {{/PADoNotShowInfoLegacy}}
</div>





<!-- legacy display -->
{{#PADoNotShowInfoLegacy}}

  <!-- priority is on the alternate display sentence -->

  {{#IsHoverCard}}
    <!-- fallback card card html
      in css: default hybrid css, but with hover instead of click -->
    <div class="expression__hybrid-wrapper">
      <div class="expression expression--single expression__hybrid expression__hybrid--hover" id="Display">
        <span class="expression__hybrid-sentence
                     {{^IsSentenceCard}} bold-yellow {{/IsSentenceCard}}
                     {{#ForceHighlightSentence}} bold-yellow {{/ForceHighlightSentence}}"
              id="hybrid-sentence">
          {{#AltDisplay}}
            {{furigana:AltDisplay}}
          {{/AltDisplay}}
          {{^AltDisplay}}
            ｢{{Sentence}}｣
          {{/AltDisplay}}
        </span>
        <span class="expression--word expression__hybrid-word
            {{#IsSentenceCard}} expression__hybrid-word--sentence-underline {{/IsSentenceCard}}
            {{^IsSentenceCard}} expression__hybrid-word--word-underline {{/IsSentenceCard}}
            expression__hybrid-word--hover-indicator"
            id="hybrid-word">
          {{Word}}
        </span>
      </div>
    </div>
  {{/IsHoverCard}}

  {{^IsHoverCard}}

    {{#IsClickCard}}
      <!-- hybrid (sentence or word) card html
        in css: default hybrid css, with click -->
      <div class="expression__hybrid-wrapper">
        <div class="expression expression--single expression__hybrid expression__hybrid--click" id="Display">
          <span class="expression__hybrid-sentence
                       {{^IsSentenceCard}} bold-yellow {{/IsSentenceCard}}
                       {{#ForceHighlightSentence}} bold-yellow {{/ForceHighlightSentence}}"
                id="hybrid-sentence">
            {{#AltDisplay}}
              {{furigana:AltDisplay}}
            {{/AltDisplay}}
            {{^AltDisplay}}
              ｢{{Sentence}}｣
            {{/AltDisplay}}
          </span>
          <span class="expression--word expression__hybrid-word
              {{#IsSentenceCard}} expression__hybrid-word--sentence-underline {{/IsSentenceCard}}
              {{^IsSentenceCard}} expression__hybrid-word--word-underline {{/IsSentenceCard}}
              expression__hybrid-word--click-indicator"
              id="hybrid-word">
            {{Word}}
          </span>
        </div>
      </div>
    {{/IsClickCard}}

    {{^IsClickCard}}

      {{#IsSentenceCard}}
        <div class="expression expression--single
                    {{#ForceHighlightSentence}} bold-yellow {{/ForceHighlightSentence}}"
              id="Display">
          {{#AltDisplay}}
            {{furigana:AltDisplay}}
          {{/AltDisplay}}
          {{^AltDisplay}}
            「{{Sentence}}」
          {{/AltDisplay}}
        </div>
      {{/IsSentenceCard}}

      {{^IsSentenceCard}}
        <div class="expression expression--single expression--word" id="Display">
          {{#AltDisplay}}
            {{furigana:AltDisplay}}
          {{/AltDisplay}}
          {{^AltDisplay}}
            {{Word}}
          {{/AltDisplay}}
        </div>
      {{/IsSentenceCard}}

    {{/IsClickCard}}

  {{/IsHoverCard}}

{{/PADoNotShowInfoLegacy}}


<!-- regular display -->
{{^PADoNotShowInfoLegacy}}
  <div class="expression-box">

    <div class="flag-box">
      <svg xmlns="http://www.w3.org/2000/svg" focusable="false" viewBox="0 0 50 50"
        style="display:inline-block;vertical-align:middle;height:1.5em;">
        <circle id="svg_circle" class="flag-box__circle" cx="25" cy="15" r="7">
          <title id=svg_title></title>
        </circle>
      </svg>
    </div>

    <!--
      different circle positions depending on whether it's a sentence or not.
      More specifically, checks if the first character is "「",
      and adjusts the position based on that
    -->
    <script>
      var circ = document.getElementById("svg_circle");
      var d = document.getElementById("Display");
      if ("{{IsSentenceCard}}" &&
          d.innerText.length > 0 && d.innerText[0] == "「") {
        circ.setAttributeNS(null, "cx", "35");
        circ.setAttributeNS(null, "cy", "11");
      }
    </script>

    <script>
      // ============================
      //  Word pitch indicator color
      // ============================
      // done in javascript to simplify templating logic
      // however, special characters in the field like " can break the code
      var svgTitle = document.getElementById("svg_title");
      var styleClass = "";

      if ("{{PADoNotTest}}{{PASeparateWordCard}}") {
        // PADoNotTest or PASeparateWordCard -> nothing is tested
        styleClass = "flag-box__circle--none";
        svgTitle.textContent = "PA: Do not test";
      } else if ("{{PASeparateSentenceCard}}{{PATestOnlyWord}}") {
        // either PASeparateSentenceCard or PATestOnlyWord -> only word is tested
        styleClass = "flag-box__circle--word";
        svgTitle.textContent = "PA: Word";
      } else if ("{{IsSentenceCard}}") {
        // sentence card but no pitch accent indicators are overridden
        styleClass = "flag-box__circle--sentence";
        svgTitle.textContent = "PA: Sentence";
      } else {
        // regular word card
        styleClass = "flag-box__circle--word";
        svgTitle.textContent = "PA: Word";
      }

      var circ = document.getElementById("svg_circle");
      circ.classList.add(styleClass);
    </script>



    <!-- priority is on the alternate display sentence -->


    {{#IsHoverCard}}
      <!-- fallback card card html
        in css: default hybrid css, but with hover instead of click -->
      <div class="expression__hybrid-wrapper">
        <div class="expression expression__hybrid expression__hybrid--hover" id="Display">
          <span class="expression__hybrid-sentence
                       {{^IsSentenceCard}} bold-yellow {{/IsSentenceCard}}
                       {{#ForceHighlightSentence}} bold-yellow {{/ForceHighlightSentence}}"
                id="hybrid-sentence">
            {{#AltDisplay}}
              {{furigana:AltDisplay}}
            {{/AltDisplay}}
            {{^AltDisplay}}
              ｢{{Sentence}}｣
            {{/AltDisplay}}
          </span>
          <span class="expression--word expression__hybrid-word
              {{#IsSentenceCard}} expression__hybrid-word--sentence-underline {{/IsSentenceCard}}
              {{^IsSentenceCard}} expression__hybrid-word--word-underline {{/IsSentenceCard}}
              expression__hybrid-word--hover-indicator"
              id="hybrid-word">
            {{Word}}
          </span>
        </div>
      </div>
    {{/IsHoverCard}}

    {{^IsHoverCard}}

      {{#IsClickCard}}
        <!-- hybrid (sentence or word) card html
          in css: default hybrid css, with click -->
        <div class="expression__hybrid-wrapper">
          <div class="expression expression__hybrid expression__hybrid--click" id="Display">
            <span class="expression__hybrid-sentence
                         {{^IsSentenceCard}} bold-yellow {{/IsSentenceCard}}
                         {{#ForceHighlightSentence}} bold-yellow {{/ForceHighlightSentence}}"
                id="hybrid-sentence">
              {{#AltDisplay}}
                {{furigana:AltDisplay}}
              {{/AltDisplay}}
              {{^AltDisplay}}
                「{{Sentence}}」
              {{/AltDisplay}}
            </span>
            <span class="expression--word expression__hybrid-word
              {{#IsSentenceCard}} expression__hybrid-word--sentence-underline {{/IsSentenceCard}}
              {{^IsSentenceCard}} expression__hybrid-word--word-underline {{/IsSentenceCard}}
              expression__hybrid-word--click-indicator"
                id="hybrid-word">
              {{Word}}
            </span>
          </div>
        </div>
      {{/IsClickCard}}

      {{^IsClickCard}}

        {{#IsSentenceCard}}
          <div class="expression {{#ForceHighlightSentence}} bold-yellow {{/ForceHighlightSentence}}"
                id="Display">
            {{#AltDisplay}}
              {{furigana:AltDisplay}}
            {{/AltDisplay}}
            {{^AltDisplay}}
              「{{Sentence}}」
            {{/AltDisplay}}
          </div>
        {{/IsSentenceCard}}

        {{^IsSentenceCard}}
          <div class="expression expression--word" id="Display">
            {{#AltDisplay}}
              {{furigana:AltDisplay}}
            {{/AltDisplay}}
            {{^AltDisplay}}
              {{Word}}
            {{/AltDisplay}}
          </div>
        {{/IsSentenceCard}}

      {{/IsClickCard}}

    {{/IsHoverCard}}


  </div> <!-- expression box -->

{{/PADoNotShowInfoLegacy}}


<script>
var hybridClick = function() {
  var hSent = document.getElementById("hybrid-sentence");
  var hWord = document.getElementById("hybrid-word");
  var circ = document.getElementById("svg_circle");
  if (hSent.classList.contains("override-display-inline-block")) {
    // currently showing sentence
    hWord.classList.remove("override-display-none");
    hSent.classList.remove("override-display-inline-block");
    if (circ !== null) {
      circ.setAttributeNS(null, "cx", "25");
      circ.setAttributeNS(null, "cy", "15");
    }
  } else {
    // currently showing word
    hWord.classList.add("override-display-none");
    hSent.classList.add("override-display-inline-block");
    if (circ !== null) { // sentence
      if (hSent.innerText.length > 0 && hSent.innerText[0] == "「") {
        circ.setAttributeNS(null, "cx", "35");
        circ.setAttributeNS(null, "cy", "11");
      }
    }
  }
}
</script>

{{#IsClickCard}}
  <script>
    var d = document.getElementById("Display");
    d.onclick = hybridClick;
  </script>
{{/IsClickCard}}

<!-- removes all newlines by default if there's no alt display + it's not a vocab card -->
{{^AltDisplay}}
  <script>
    var sent = null;
    if ("{{IsClickCard}}{{IsHoverCard}}") {
      sent = document.getElementById("hybrid-sentence");
    } else if ("{{IsSentenceCard}}") {
      sent = document.getElementById("Display");
    }
    if (sent !== null) {
      sent.innerHTML = sent.innerHTML.replace(/<br>/g, "");
    }
  </script>
{{/AltDisplay}}

{{#HintNotHidden}}
  <div class="center-box-1 hint">
    <div class="center-box-2">
      <div class="bold-yellow">{{HintNotHidden}}</div>
    </div>
  </div>
{{/HintNotHidden}}

<!-- https://stackoverflow.com/questions/1269589/css-center-block-but-align-contents-to-the-left -->
<!-- tl;dr wrap anything you want centered + left justified with center-box-1 and center-box-2 -->
{{#Hint}}
  <details class="hint">
    <summary>Hint</summary>
    <div class="center-box-1">
      <div class="center-box-2">
        <div class="bold-yellow">{{Hint}}</div>
      </div>
    </div>
  </details>
{{/Hint}}



<!-- regular display -->
<!-- displays the audio and show/hide button, used only when testing pitch accent -->
{{^PADoNotShowInfoLegacy}}

  {{^PADoNotTest}} {{^PASeparateWordCard}}

    <!-- if the display is a sentence but we only want to test word pitch accent -->
    {{#IsSentenceCard}}

      <!-- ankified `PASeparateSentenceCard or PATestOnlyWord` -->
      {{#PASeparateSentenceCard}} {{^PATestOnlyWord}}
        <button id="PAButton" oncontextmenu="event.preventDefault();" onclick="logMouseButton()">Show</button>
      {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}
      {{^PASeparateSentenceCard}} {{#PATestOnlyWord}}
        <button id="PAButton" oncontextmenu="event.preventDefault();" onclick="logMouseButton()">Show</button>
      {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}
      {{#PASeparateSentenceCard}} {{#PATestOnlyWord}}
        <button id="PAButton" oncontextmenu="event.preventDefault();" onclick="logMouseButton()">Show</button>
      {{/PATestOnlyWord}} {{/PASeparateSentenceCard}}

      <!-- script here because too lazy to copy/paste -->
      <!-- https://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/button -->
      <script>
        var paButton = document.getElementById("PAButton");
        var d = document.getElementById("Display");

        function logMouseButton() {
          if (paButton.innerText == "Show") {
            paButton.innerText = "Hide";
            d.classList.add("bold-yellow");
          } else {
            paButton.innerText = "Show";
            d.classList = "expression";
          }
        }
      </script>

    {{/IsSentenceCard}}

  {{/PASeparateWordCard}} {{/PADoNotTest}}


  <!--
    if the display is a word: show sentence preview (spoilered)
  -->
  {{^IsSentenceCard}} {{^IsHoverCard}} {{^IsClickCard}}
    <details>
      <summary class=glossary-details>Full Sentence</summary>
      <div class="center-box-1">
        <div class="center-box-2">
          <div class="full-sentence bold-yellow" id="full_sentence_front">
            {{furigana:SentenceReading}}
          </div>
        </div>
      </div>
    </details>
  {{/IsClickCard}} {{/IsHoverCard}} {{/IsSentenceCard}}


  <!-- we include the audio at the front regardless if we test PA or not -->
  <script>
    // =====================
    //  THIS PART IS A HACK
    // =====================
    // this hack is to not auto-play the audio at the front of the card
    // https://forums.ankiweb.net/t/disabling-audio-autoplay-for-certain-fields/6318/3
    // https://forums.ankiweb.net/t/controlling-display-and-function-of-audio-buttons/10234
    var elem = document.querySelector(".soundLink, .replaybutton");
    if (elem) {
      elem.click();
    }
  </script>

  <span id="audio-front-silence" style="display:none">{{PASilence}}</span>
  <span id="audio-front">
    {{#SentenceAudio}}
      {{SentenceAudio}}
    {{/SentenceAudio}}
  </span>


{{/PADoNotShowInfoLegacy}}



<script>
  // Javascript to have hybrid cards show the sentence with "shift"
  // For some reason, this only works on the first document shown (upon javascript refresh).
  // Therefore, this is not included in the backside html;
  // the full sentence is already shown at the back side.
  document.addEventListener("keyup", e => {
    var hSent = document.getElementById("hybrid-sentence");
    var hWord = document.getElementById("hybrid-word");

    if (hSent && hWord) {
      if (e.shiftKey) {
        hybridClick();
      }
    }
  })
</script>
