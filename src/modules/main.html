{# gathers all the modules together in one `modules` variable #}

{#

Required data members of MOD:
- MOD.id

Optional data members of MOD:
- MOD.js
- MOD.dependencies

#}

{% set modules = {} %}
{% set _module_ids = [] %}

{% if COMPILE_OPTIONS("allow-user-defined-modules").item() %}

  {% do _module_ids.extend(COMPILE_OPTIONS("enabled-modules").list()) %}

{% else %}
  {# ORDER MATTERS HERE! #}

  {# img-utils is ran after auto-pitch-accent to properly calculate the height of the left div #}
  {# time-performance absolutely must be first to spawn the TIME_PERFORMANCE variable #}
  {% set all_module_ids = [
    "time-performance",
    "keybinds",
    "cache",

    "auto-pitch-accent",
    "img-utils-minimal",
    "img-utils",

    "sent-utils",
    "auto-highlight-word",

    "kanji-hover",
    "customize-open-fields",
    "word-indicators",

    "info-circle-utils",
    "fix-ruby-positioning",
    "check-duplicate-key"]
  %}

  {% for mid in all_module_ids %}
    {% if mid in COMPILE_OPTIONS("enabled-modules").list() %}
      {% do _module_ids.append(mid) %}
    {% endif %}
  {% endfor %}

{% endif %}



{# searches for dependencies (this is just a basic DFS) #}
{% macro _visit_node(node, visited_cache) %}
  {% if node not in visited_cache %}
    {% do visited_cache.append(node) %}
    {% set mod_path = ("modules/" + node + "/main.html") %}
    {% from mod_path import MOD as m with context %}
    {% if m.dependencies is defined %}
      {% for dep in m.dependencies %}
        {{ _visit_node(dep, visited_cache) }}
      {% endfor %}
    {% endif %}
  {% endif %}
{% endmacro %}

{% macro _update_module_ids_with_deps() %}

  {% set _visited_cache = [] %} {# shallow copy #}
  {% for mid in _module_ids %}
    {{ _visit_node(mid, _visited_cache) }}
  {% endfor %}
  {{ _module_ids.clear() }}
  {{ _module_ids.extend(_visited_cache) }}

{% endmacro %}

{{ _update_module_ids_with_deps() }}


{% for mod_name in _module_ids %}

  {% set mod_path = ("modules/" + mod_name + "/main.html") %}
  {% from mod_path import MOD as m with context %}
  {% do modules.update({mod_name: m}) %}

{% endfor %}


{# _up_ns == use_persistence namespace #}
{% set _up_ns = namespace() %}
{% set _up_ns.use_persistence = False %}
{% for m in modules.values() %}
{% if m.use_persistence is defined and m.use_persistence %}
{% set _up_ns.use_persistence = True %}
{% endif %}
{% endfor %}

{% set USE_PERSISTENCE = _up_ns.use_persistence %}



